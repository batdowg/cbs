{% macro render_item(item) %}
  {% set href = item.endpoint and url_for(item.endpoint, **(item.args or {})) %}
  {% set is_current = href and href == request.path %}
  {% set children = [] %}
  {% set has_active_descendant = false %}
  {% if item.children %}
    {% for child in item.children %}
      {% set rendered = render_item(child) %}
      {% if 'aria-current="page"' in rendered or 'is-ancestor' in rendered %}
        {% set has_active_descendant = true %}
      {% endif %}
      {% set children = children + [rendered] %}
    {% endfor %}
  {% endif %}
  {% if item.children %}
    <details class="{{ item.id }}{% if has_active_descendant %} is-ancestor{% endif %}">
      <summary{% if is_current %} aria-current="page"{% endif %}>{{ item.label }}</summary>
      <ul class="kt-subnav">
      {% for ch in children %}
        <li{% if 'is-ancestor' in ch %} class="is-ancestor"{% endif %}>{{ ch|safe }}</li>
      {% endfor %}
      </ul>
    </details>
  {% else %}
    <a href="{{ href }}"{% if is_current %} aria-current="page"{% endif %}>{{ item.label }}</a>
  {% endif %}
{% endmacro %}
<nav class="kt-nav">
  <a href="/{{''}}"><img src="{{ url_for('static', filename='ktlogo1.png') }}" onerror="this.onerror=null;this.src='/logo.png';" alt="KT Logo" style="max-height:48px;"></a>
  {% for item in nav_menu %}
    {{ render_item(item) }}
  {% endfor %}
  {% if view_options|length > 1 %}
  <form method="post" action="{{ url_for('settings_view') }}" class="kt-sidebar-footer">
    <label>View:</label>
    <select name="view" onchange="this.form.submit()">
      {% for opt in view_options %}
      {% set label = 'Session Admin' if opt == 'CSA' else opt.replace('_', ' ').title() %}
      <option value="{{ opt }}" {% if opt == active_view %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </form>
  {% endif %}
</nav>
