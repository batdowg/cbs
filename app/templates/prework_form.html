{% extends "base.html" %}
{% block title %}Prework{% endblock %}
{% block content %}
<h1>Prework for {{ assignment.session.title if assignment.session else '' }}</h1>
<a href="{{ url_for('learner.prework_download', assignment_id=assignment.id) }}" target="_blank">Download Prework (PDF)</a>
{% if assignment.template and assignment.template.info_html %}
<div>{{ assignment.template.info_html|safe }}</div>
{% endif %}
<form method="post">
{% for q in questions %}
<div class="question">
<div class="question-text rich-text" id="question-{{ q.index }}">{{ q.text | prework_rich_text }}</div>
{% if q.kind == 'LIST' %}
{% set items = answers.get(q.index, {}) %}
{% set sorted_items = items|dictsort %}
{% if not sorted_items %}
  {% set sorted_items = [(0, '')] %}
{% endif %}
{% set next_index = sorted_items[-1][0] + 1 %}
<div class="list-question" data-q-index="{{ q.index }}" data-max="{{ q.max_items or 10 }}" data-next-index="{{ next_index }}">
  <div class="list-items">
    {% for item_index, text in sorted_items %}
    <div class="item">
      <textarea name="answers[{{ q.index }}][]" data-item-index="{{ item_index }}" rows="3" cols="60">{{ text }}</textarea>
      <button type="button" class="remove-item">Remove</button>
    </div>
    {% endfor %}
  </div>
  <button type="button" class="add-item">Add another</button>
</div>
{% else %}
<textarea name="answers[{{ q.index }}][]" rows="3" cols="60">{{ (answers.get(q.index, {}) or {0:''}).get(0) }}</textarea>
{% endif %}
</div>
{% endfor %}
<button type="submit">Submit</button>
</form>
{% if assignment.status == 'COMPLETED' %}
<p>Status: Completed</p>
{% endif %}
<script>
const assignmentId = {{ assignment.id }};
document.querySelectorAll('.list-question').forEach(function(q){
  const max = parseInt(q.dataset.max);
  let next = parseInt(q.dataset.nextIndex || '0', 10);
  q.querySelectorAll('textarea').forEach(function(ta){
    const idx = parseInt(ta.dataset.itemIndex || '0', 10);
    if (!Number.isNaN(idx) && idx >= next) {
      next = idx + 1;
    }
    bind(ta);
  });
  function bind(ta){
    ta.addEventListener('blur', function(){
      const item = ta.dataset.itemIndex;
      fetch(`/prework/${assignmentId}/autosave`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question_index: q.dataset.qIndex, item_index: item, text: ta.value})});
    });
  }
  q.querySelectorAll('.remove-item').forEach(function(btn){
    btn.addEventListener('click', function(){
      const div = btn.parentElement;
      const ta = div.querySelector('textarea');
      fetch(`/prework/${assignmentId}/autosave`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question_index: q.dataset.qIndex, item_index: ta.dataset.itemIndex, text: ''})}).then(()=>{div.remove();});
    });
  });
  q.querySelector('.add-item').addEventListener('click', function(){
    const count = q.querySelectorAll('textarea').length;
    if (count >= max) return;
    const div = document.createElement('div');
    div.className='item';
    const ta = document.createElement('textarea');
    ta.setAttribute('name', `answers[${q.dataset.qIndex}][]`);
    ta.setAttribute('rows', '3');
    ta.setAttribute('cols', '60');
    ta.dataset.itemIndex = String(next);
    const remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'remove-item';
    remove.textContent = 'Remove';
    div.appendChild(ta);
    div.appendChild(remove);
    q.querySelector('.list-items').appendChild(div);
    bind(ta);
    remove.addEventListener('click', function(){
      fetch(`/prework/${assignmentId}/autosave`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question_index: q.dataset.qIndex, item_index: ta.dataset.itemIndex, text: ''})}).then(()=>{div.remove();});
    });
    next += 1;
  });
});
</script>
{% endblock %}
