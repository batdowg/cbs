{% extends 'base.html' %}
{% block title %}Materials Dashboard{% endblock %}
{% block content %}
{% set breadcrumbs = [{'href': url_for('home'), 'label': 'Home'}, {'label': 'Materials Dashboard'}] %}
<h1>Materials Dashboard</h1>
{% include 'shared/_breadcrumbs.html' %}
<form method="get">
  <label>Client
    <select name="client_id">
      <option value="">All</option>
      {% for c in clients %}
        <option value="{{ c.id }}" {% if client_id==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Order Type
    <select name="order_type">
      <option value="">All</option>
      {% for ot in order_types %}
        <option value="{{ ot }}" {% if order_type==ot %}selected{% endif %}>{{ ot }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Status
    <select name="status">
      <option value="">All</option>
      {% for st in statuses %}
        <option value="{{ st }}" {% if status==st %}selected{% endif %}>{{ st }}</option>
      {% endfor %}
    </select>
  </label>
  <button type="submit">Filter</button>
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="dir" value="{{ dir }}">
</form>
<p>
  {% if show_closed %}
    <a href="{{ url_for('materials_orders.list_orders', client_id=client_id, order_type=order_type, status=status) }}">Hide closed sessions</a>
  {% else %}
    <a href="{{ url_for('materials_orders.list_orders', client_id=client_id, order_type=order_type, status=status, closed=1) }}">Show closed sessions</a>
  {% endif %}
</p>
{% set base = '' %}
{% if client_id %}{% set base = base + '&client_id=' + client_id|string %}{% endif %}
{% if order_type %}{% set base = base + '&order_type=' + order_type|urlencode %}{% endif %}
{% if status %}{% set base = base + '&status=' + status %}{% endif %}
{% if show_closed %}{% set base = base + '&closed=1' %}{% endif %}
{% if current_user and current_user.id %}
  {% set storage_key = 'cbs.materials.columns.' ~ current_user.id %}
  {% set width_key = 'cbs.materials.colwidths.' ~ current_user.id %}
{% else %}
  {% set storage_key = 'cbs.materials.columns' %}
  {% set width_key = 'cbs.materials.colwidths' %}
{% endif %}
<div class="dashboard-table" data-column-chooser data-storage-key="{{ storage_key }}" data-width-storage-key="{{ width_key }}" data-chooser-label="Choose columns">
  <div class="table-toolbar">
    <button type="button" class="btn btn-secondary btn-sm" data-column-chooser-toggle aria-haspopup="dialog" aria-expanded="false">Columns</button>
  </div>
  <div class="kt-table-wrapper">
    <table class="kt-table">
      <thead>
        <tr>
          {% macro sort_link(label, field) -%}
            {% set is_sorted = sort == field %}
            {% set next_dir = 'desc' if is_sorted and dir == 'asc' else 'asc' %}
            <a href="?sort={{ field }}&dir={{ next_dir }}{{ base }}">{{ label }}</a>
          {%- endmacro %}
          <th scope="col" data-column-key="order_id" data-column-label="ID" data-column-required="true" class="cell-nowrap">{{ sort_link('ID','order_id') }}</th>
          <th scope="col" data-column-key="title" data-column-label="Title" data-column-required="true">{{ sort_link('Title','title') }}</th>
          <th scope="col" data-column-key="status" data-column-label="Status">{{ sort_link('Status','status') }}</th>
          <th scope="col" data-column-key="start_date" data-column-label="Workshop start date">{{ sort_link('Workshop start date','start_date') }}</th>
          <th scope="col" data-column-key="client" data-column-label="Client">{{ sort_link('Client','client') }}</th>
          <th scope="col" data-column-key="order_type" data-column-label="Order type">{{ sort_link('Order type','order_type') }}</th>
          <th scope="col" data-column-key="workshop_code" data-column-label="Workshop">{{ sort_link('Workshop','workshop_code') }}</th>
          <th scope="col" data-column-key="processed_digital" data-column-label="Processed — Digital" data-column-default-hidden="true">{{ sort_link('Processed — Digital','processed_digital') }}</th>
          <th scope="col" data-column-key="processed_physical" data-column-label="Processed — Physical" data-column-default-hidden="true">{{ sort_link('Processed — Physical','processed_physical') }}</th>
          <th scope="col" data-column-key="arrival_date" data-column-label="Latest arrival" class="cell-nowrap">{{ sort_link('Latest arrival','arrival_date') }}</th>
          <th scope="col" data-column-key="bulk_receiver" data-column-label="Bulk Receiver" data-column-default-hidden="true">{{ sort_link('Bulk Receiver','bulk_receiver') }}</th>
          <th scope="col" data-column-key="outline" data-column-label="Outline" data-column-default-hidden="true">{{ sort_link('Outline','outline') }}</th>
          <th scope="col" data-column-key="teams" data-column-label="Credits/Teams" data-column-default-hidden="true">{{ sort_link('Credits/Teams','teams') }}</th>
          <th scope="col" data-column-key="facilitators" data-column-label="Facilitator(s)" data-column-default-hidden="true">Facilitator(s)</th>
          <th scope="col" data-column-key="learners" data-column-label="Learner list" data-column-default-hidden="true">Learner list</th>
          <th scope="col" data-column-key="region" data-column-label="Region" data-column-default-hidden="true">{{ sort_link('Region','region') }}</th>
          <th scope="col" data-column-key="shipping_title" data-column-label="Shipping location title" data-column-default-hidden="true">{{ sort_link('Shipping location title','shipping_title') }}</th>
          <th scope="col" data-column-key="workshop_status" data-column-label="Workshop status">{{ sort_link('Workshop status','workshop_status') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td data-column-key="order_id" class="cell-nowrap">{{ row.order_id }}</td>
          <td data-column-key="title">
            <span class="cell-ellipsis" title="{{ row.title }}">
              <a href="{{ url_for('materials.materials_view', session_id=row.session_id)}}">{{ row.title }}</a>
            </span>
          </td>
          <td data-column-key="status">
            {% if row.status %}
              <span class="pill pill--{{ row.status|lower|replace(' ', '') }}">{{ row.status }}</span>
            {% else %}—{% endif %}
          </td>
          <td data-column-key="start_date" class="cell-nowrap">{{ row.start_date|default('', true) }}</td>
          <td data-column-key="client">
            {% if row.client %}<span class="cell-ellipsis" title="{{ row.client }}">{{ row.client }}</span>{% endif %}
          </td>
          <td data-column-key="order_type">{{ row.order_type }}</td>
          <td data-column-key="workshop_code">
            {% if row.workshop_code %}
              <span class="cell-ellipsis" title="{{ row.workshop_name }}">{{ row.workshop_code }}</span>
            {% endif %}
          </td>
          <td data-column-key="processed_digital" class="cell-nowrap">{{ row.processed_digital_display or '—' }}</td>
          <td data-column-key="processed_physical" class="cell-nowrap">{{ row.processed_physical_display or '—' }}</td>
          <td data-column-key="arrival_date" class="cell-nowrap">{{ row.arrival_date|default('', true) }}</td>
          <td data-column-key="bulk_receiver">{{ row.bulk_receiver }}</td>
          <td data-column-key="outline">{{ row.outline }}</td>
          <td data-column-key="teams" class="cell-nowrap">
            {% if row.credits is not none %}
              {{ row.credits }} / {{ row.teams }}
            {% else %}
              — / —
            {% endif %}
          </td>
          <td data-column-key="facilitators">
            {% if row.facilitators %}
              <span class="cell-ellipsis" title="{{ row.facilitators|join(', ') }}">{{ row.facilitators|join(', ') }}</span>
            {% endif %}
          </td>
          <td data-column-key="learners">
            {% if row.learners %}
              {% set visible = row.learners[:3] %}
              {% set extra = row.learners|length - visible|length %}
              <span class="cell-ellipsis" title="{{ row.learners|join(', ') }}">
                {{ visible|join(', ') }}{% if extra > 0 %} +{{ extra }} more{% endif %}
              </span>
            {% endif %}
          </td>
          <td data-column-key="region">{{ row.region }}</td>
          <td data-column-key="shipping_title">
            {% if row.shipping_title %}
              <span class="cell-ellipsis" title="{{ row.shipping_title }}">{{ row.shipping_title }}</span>
            {% endif %}
          </td>
          <td data-column-key="workshop_status">
            {% if row.workshop_status %}
              <span class="pill pill--{{ row.workshop_status|lower|replace(' ', '') }}">{{ row.workshop_status }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/column_chooser.js') }}" defer></script>
{% endblock %}
