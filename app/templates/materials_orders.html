{% extends 'base.html' %}
{% block title %}Materials Dashboard{% endblock %}
{% block content %}
{% set breadcrumbs = [{'href': url_for('home'), 'label': 'Home'}, {'label': 'Materials Dashboard'}] %}
<h1>Materials Dashboard</h1>
{% include 'shared/_breadcrumbs.html' %}
<form method="get">
  <label>Client
    <select name="client_id">
      <option value="">All</option>
      {% for c in clients %}
        <option value="{{ c.id }}" {% if client_id==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Order Type
    <select name="order_type">
      <option value="">All</option>
      {% for ot in order_types %}
        <option value="{{ ot }}" {% if order_type==ot %}selected{% endif %}>{{ ot }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Status
    <select name="status">
      <option value="">All</option>
      {% for st in statuses %}
        <option value="{{ st }}" {% if status==st %}selected{% endif %}>{{ st }}</option>
      {% endfor %}
    </select>
  </label>
  <button type="submit">Filter</button>
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="dir" value="{{ dir }}">
</form>
<p>
  {% if show_closed %}
    <a href="{{ url_for('materials_orders.list_orders', client_id=client_id, order_type=order_type, status=status) }}">Hide closed sessions</a>
  {% else %}
    <a href="{{ url_for('materials_orders.list_orders', client_id=client_id, order_type=order_type, status=status, closed=1) }}">Show closed sessions</a>
  {% endif %}
</p>
{% set base = '' %}
{% if client_id %}{% set base = base + '&client_id=' + client_id|string %}{% endif %}
{% if order_type %}{% set base = base + '&order_type=' + order_type|urlencode %}{% endif %}
{% if status %}{% set base = base + '&status=' + status %}{% endif %}
{% if show_closed %}{% set base = base + '&closed=1' %}{% endif %}
{% if current_user and current_user.id %}
  {% set storage_key = 'cbs.materials.columns.' ~ current_user.id %}
{% else %}
  {% set storage_key = 'cbs.materials.columns' %}
{% endif %}
<div class="dashboard-table" data-column-chooser data-storage-key="{{ storage_key }}" data-chooser-label="Choose columns">
  <div class="table-toolbar">
    <button type="button" class="btn btn-secondary btn-sm" data-column-chooser-toggle aria-haspopup="dialog" aria-expanded="false">Columns</button>
  </div>
  <div class="kt-table-wrapper">
    <table class="kt-table">
      <thead>
        <tr>
          {% macro sort_link(label, field) -%}
            {% set is_sorted = sort == field %}
            {% set next_dir = 'desc' if is_sorted and dir == 'asc' else 'asc' %}
            <a href="?sort={{ field }}&dir={{ next_dir }}{{ base }}">{{ label }}</a>
          {%- endmacro %}
          <th scope="col" data-column-key="order_id" data-column-label="Order ID" data-column-required="true" class="cell-nowrap">{{ sort_link('Order ID','order_id') }}</th>
          <th scope="col" data-column-key="title" data-column-label="Workshop title" data-column-required="true">{{ sort_link('Workshop title','title') }}</th>
          <th scope="col" data-column-key="client" data-column-label="Client">{{ sort_link('Client','client') }}</th>
          <th scope="col" data-column-key="workshop_type" data-column-label="Workshop">{{ sort_link('Workshop','workshop_type') }}</th>
          <th scope="col" data-column-key="arrival_date" data-column-label="Latest Arrival Date" class="cell-nowrap">{{ sort_link('Latest Arrival Date','arrival_date') }}</th>
          <th scope="col" data-column-key="order_type" data-column-label="Materials Order type">{{ sort_link('Materials Order type','order_type') }}</th>
          <th scope="col" data-column-key="materials_status" data-column-label="Materials order status">{{ sort_link('Materials order status','materials_status') }}</th>
          <th scope="col" data-column-key="session_status" data-column-label="Workshop status">{{ sort_link('Workshop status','session_status') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td data-column-key="order_id" class="cell-nowrap">{{ row.order_id }}</td>
          <td data-column-key="title"><a href="{{ url_for('materials.materials_view', session_id=row.session_id)}}">{{ row.title }}</a></td>
          <td data-column-key="client">{{ row.client }}</td>
          <td data-column-key="workshop_type">{{ row.workshop_type }}</td>
          <td data-column-key="arrival_date" class="cell-nowrap">{{ row.arrival_date }}</td>
          <td data-column-key="order_type">{{ row.order_type }}</td>
          <td data-column-key="materials_status"><span class="pill pill--{{ row.materials_status|lower|replace(' ', '') }}">{{ row.materials_status }}</span></td>
          <td data-column-key="session_status"><span class="pill pill--{{ row.session_status|lower|replace(' ', '') }}">{{ row.session_status }}</span></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/column_chooser.js') }}" defer></script>
{% endblock %}
