{% extends "base.html" %}
{% block title %}Prework - {{ session.title }}{% endblock %}
{% block content %}
<h1>Prework for {{ session.title }}</h1>
{% set certificate_only = session.is_certificate_only %}
<nav class="kt-tabs">
  <a href="{{ url_for('sessions.session_detail', session_id=session.id) }}">Details</a>
  <a href="{{ url_for('sessions.session_prework', session_id=session.id) }}" aria-current="page">Prework</a>
  {% if not certificate_only %}
  <a href="{{ url_for('materials.materials_view', session_id=session.id) }}">Materials Order</a>
  {% endif %}
</nav>
{% include "sessions/_prework_summary.html" %}
<form method="post">
  <input type="hidden" name="action" value="toggle_no_prework">
  <label><input type="checkbox" name="no_prework" value="1" {% if session.no_prework %}checked{% endif %}> No prework for this workshop</label>
  <button type="submit">Save</button>
</form>
{% if session.no_prework and not any_assignment %}
<p>Prework disabled for this workshop.</p>
{% endif %}
<div class="kt-table-wrapper">
  <table class="kt-table">
    <thead>
      <tr><th scope="col">Name</th><th scope="col">Email</th><th scope="col">Status</th><th scope="col">Sent</th><th scope="col">Completed</th><th scope="col">Account Sent</th><th scope="col">Export</th><th scope="col">Actions</th></tr>
    </thead>
    <tbody>
    {% if rows %}
    {% for p, account, assignment in rows %}
    <tr>
      <td>{{ p.full_name }}</td>
      <td>{{ p.email }}</td>
      <td>{% if assignment %}{{ assignment.status }}{% elif session.no_prework %}WAIVED{% else %}PENDING{% endif %}</td>
      <td>{{ assignment.sent_at|fmt_dt if assignment else '' }}</td>
      <td>{{ assignment.completed_at|fmt_dt if assignment else '' }}</td>
      <td>{{ assignment.account_sent_at|fmt_dt if assignment else '' }}</td>
      <td>{% if assignment %}<a href="{{ url_for('learner.prework_download', assignment_id=assignment.id) }}" target="_blank">Download</a>{% endif %}</td>
      <td>
        {% if assignment and assignment.status != 'WAIVED' and not session.no_prework %}
        <form method="post" style="display:inline">
          <input type="hidden" name="action" value="resend">
          <input type="hidden" name="participant_id" value="{{ p.id }}">
          <button type="submit">Resend</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    {% else %}
      {% with colspan=8 %}

        {% include 'shared/_table_empty.html' %}

      {% endwith %}
    {% endif %}
    </tbody>
  </table>
</div>
<form method="post" style="display:inline">
  <input type="hidden" name="action" value="send_all">
  <button type="submit" {% if session.no_prework %}disabled{% endif %}>Send Prework</button>
</form>
<form method="post" style="display:inline">
  <input type="hidden" name="action" value="send_accounts">
  <button type="submit">Send Accounts without Prework</button>
</form>
{% endblock %}
