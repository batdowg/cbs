{% extends 'base.html' %}
{% block title %}{{ 'New Session' if not session or not session.id else 'Edit Session' }}{% endblock %}
{% block content %}
<h1>{{ 'New Session' if not session or not session.id else 'Edit Session' }}</h1>
<form method="post">
  <fieldset>
    <legend>Session Info</legend>
    {% set _title = title_override if title_override is not none else session.title %}
    <div><label>Title* <input type="text" name="title" value="{{ _title or '' }}" required></label></div>
    <div><label>Client*
      <select name="client_id" id="client-select" required>
        <option value="">--Select--</option>
        {% for c in clients %}
        <option value="{{ c.id }}" {% if session and session.client_id==c.id %}selected{% endif %} data-crm="{% if c.crm %}{{ c.crm.full_name or c.crm.email }}{% endif %}">{{ c.name }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-client" class="button">Add Client</a>
    </label></div>
    <div><label>Sponsor <input type="text" name="sponsor" value="{{ session.sponsor or '' }}"></label></div>
    <div><label>Region*
      <select name="region" required>
        <option value="">--Select--</option>
        {% for opt in ['NA','EU','SEA','Other'] %}
        <option value="{{ opt }}" {% if session and session.region==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div>CRM: <span id="crm-display">{% if session and session.client and session.client.crm %}{{ session.client.crm.full_name or session.client.crm.email }}{% endif %}</span></div>
    <div><label>Client Session Administrator <input type="email" name="csa_email" value="{{ session.csa_account.email if session and session.csa_account else '' }}"></label></div>
    <div><label>Workshop Location
      <select name="workshop_location_id" id="workshop-location-select">
        <option value=""></option>
        {% for loc in workshop_locations %}
        <option value="{{ loc.id }}" {% if session.workshop_location_id==loc.id %}selected{% endif %}>{{ loc.label }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-workshop-location">Add</a>
    </label></div>
  </fieldset>
  <fieldset>
    <legend>Details</legend>
    <div><label>Workshop Type*
      <select name="workshop_type_id" required>
        <option value="">--Select--</option>
        {% for wt in workshop_types %}
        <option value="{{ wt.id }}" {% if session and session.workshop_type_id==wt.id %}selected{% endif %}>{{ wt.code }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Delivery Type*
      <select name="delivery_type" required>
        <option value="">--Select--</option>
        {% for opt in ['Onsite','Virtual','Self-paced','Hybrid'] %}
        <option value="{{ opt }}" {% if session and session.delivery_type==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Language*
      <select name="language" required>
        {% for lang in languages %}
        <option value="{{ lang.name }}" {% if session.language==lang.name %}selected{% endif %}>{{ lang.name }}</option>
        {% endfor %}
        {% if extra_language %}
        <option value="{{ extra_language }}" selected>{{ extra_language }}</option>
        {% endif %}
      </select>
    </label></div>
    <div><label>Simulation Outline
      <select name="simulation_outline_id">
        <option value=""></option>
        {% for so in simulation_outlines %}
        <option value="{{ so.id }}" {% if session.simulation_outline_id==so.id %}selected{% endif %}>{{ so.label }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Capacity* <input type="number" name="capacity" value="{{ session.capacity or 16 }}" required></label></div>
    <div><label>Start Date* <input type="date" id="start-date" name="start_date" value="{{ session.start_date or '' }}" required></label></div>
    <div><label>End Date* <input type="date" id="end-date" name="end_date" value="{{ session.end_date or '' }}" min="{{ session.start_date or '' }}" required></label><small>End date must be the same day or after the start date.</small></div>
    {% if past_warning %}
    <div style="color:red;"><label><input type="checkbox" name="ack_past" value="true" required> The selected start date is in the past. I'm sure.</label></div>
    {% endif %}
    <div><label>Daily Start Time <input type="time" name="daily_start_time" value="{{ daily_start_time_str or '08:00' }}"></label></div>
    <div><label>Daily End Time <input type="time" name="daily_end_time" value="{{ daily_end_time_str or '17:00' }}"></label></div>
    <div><label>Timezone
      <select name="timezone">
        <option value="">--Select--</option>
        {% for tz in timezones %}
        <option value="{{ tz }}" {% if session.timezone==tz %}selected{% endif %}>{{ tz }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Notes<br><textarea name="notes">{{ session.notes or '' }}</textarea></label></div>
    <div><label>Lead Facilitator
      <select name="lead_facilitator_id">
        <option value="">--Select--</option>
        {% for u in facilitators %}
        <option value="{{ u.id }}" {% if session and session.lead_facilitator_id==u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label><input type="checkbox" id="include-all-fac" {% if include_all_facilitators %}checked{% endif %}> Include out-of-region facilitators</label></div>
    <div>Additional Facilitators:
      <div id="additional-facilitators">
        {% set adds = session.facilitators if session else [] %}
        {% if adds %}
          {% for fac in adds %}
          <select name="additional_facilitators">
            <option value="">--Select--</option>
            {% for u in facilitators %}
            <option value="{{ u.id }}" {% if u.id==fac.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
          {% endfor %}
        {% else %}
          <select name="additional_facilitators">
            <option value="">--Select--</option>
            {% for u in facilitators %}
            <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
      <button type="button" id="add-fac">Add another facilitator</button>
    </div>
  </fieldset>
  {% if session.id %}
  {% set disabled_all = session.cancelled or session.on_hold %}
  <fieldset>
    <legend>Lifecycle</legend>
    <div><label><input type="checkbox" name="materials_ordered" value="1" {% if session.materials_ordered %}checked{% endif %} {% if disabled_all %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all else 0 }}"> Materials ordered</label></div>
    {% set ready_base_disabled = disabled_all or participants_count==0 or session.delivered %}
    <div><label><input type="checkbox" name="ready_for_delivery" value="1" {% if session.ready_for_delivery %}checked{% endif %} {% if ready_base_disabled %}disabled{% endif %} data-base-disabled="{{ 1 if ready_base_disabled else 0 }}" title="{% if participants_count==0 %}Add participants before marking Ready for delivery.{% elif session.delivered %}Delivered is set{% endif %}"> Ready for delivery</label></div>
    <div><label><input type="checkbox" name="info_sent" value="1" {% if session.info_sent %}checked{% endif %} {% if disabled_all %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all else 0 }}"> Workshop info sent</label></div>
    {% set delivered_base_disabled = disabled_all or not session.ready_for_delivery or (session.end_date and session.end_date > today) %}
    <div>
      <label><input type="checkbox" name="delivered" value="1" {% if session.delivered %}checked{% endif %} {% if delivered_base_disabled %}disabled{% endif %} data-base-disabled="{{ 1 if delivered_base_disabled else 0 }}" title="{% if not session.ready_for_delivery %}Requires Ready for delivery{% elif session.end_date and session.end_date > today %}Cannot mark Delivered before the end date{% endif %}"> Delivered</label>
      {% if not delivered_base_disabled %}<input type="hidden" name="delivered" value="0">{% endif %}
    </div>
    <div><label><input type="checkbox" name="finalized" value="1" {% if session.finalized %}checked{% endif %} {% if disabled_all or not session.delivered %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all or not session.delivered else 0 }}" title="{% if not session.delivered %}Requires Delivered{% endif %}"> Finalized</label></div>
  </fieldset>
  <div>Status: <span class="badge">{{ session.computed_status }}</span></div>
  {% endif %}
  {% if not session or not session.id %}
  <button type="submit">Proceed to materials order</button>
  <button type="submit" name="action" value="no_material">No Materials Order (Save)</button>
  {% else %}
  <button type="submit">Save</button>
  {% endif %}
</form>
<script>
  var startField = document.getElementById('start-date');
  var endField = document.getElementById('end-date');
  function syncEndMin(){
    if(endField && startField){ endField.min = startField.value; }
  }
  if(startField && endField){
    syncEndMin();
    startField.addEventListener('change', syncEndMin);
  }
  var delivered = document.querySelector('input[name="delivered"]');
  var ready = document.querySelector('input[name="ready_for_delivery"]');
  var finalized = document.querySelector('input[name="finalized"]');
  var materials = document.querySelector('input[name="materials_ordered"]');
  var info = document.querySelector('input[name="info_sent"]');
  function updateStates(){
    if(delivered){
      if(delivered.checked){
        if(materials){ materials.checked = true; }
        if(info){ info.checked = true; }
        if(ready){ ready.disabled = true; }
      }else if(ready){
        ready.disabled = ready.dataset.baseDisabled === '1';
      }
      delivered.disabled = delivered.dataset.baseDisabled === '1' || (ready && !ready.checked);
    }
    if(finalized){
      if(finalized.checked){
        if(materials){ materials.disabled = true; }
        if(ready){ ready.disabled = true; }
        if(info){ info.disabled = true; }
        if(delivered){ delivered.disabled = true; }
      }else{
        if(materials){ materials.disabled = materials.dataset.baseDisabled === '1'; }
        if(ready){ ready.disabled = ready.dataset.baseDisabled === '1'; }
        if(info){ info.disabled = info.dataset.baseDisabled === '1'; }
        if(delivered){ delivered.disabled = delivered.dataset.baseDisabled === '1' || (ready && !ready.checked); }
      }
    }
  }
  if(delivered){
    updateStates();
    delivered.addEventListener('change', function(){
      if(delivered.checked){
        var end = document.querySelector('input[name="end_date"]').value;
        var today = new Date().toISOString().slice(0,10);
        if(!ready.checked){
          alert('Delivered requires "Ready for delivery" first.');
          delivered.checked = false;
        }else if(end && end > today){
          alert('Cannot mark Delivered before the end date.');
          delivered.checked = false;
        }else if(!confirm('Mark this session Delivered? Certificates become available.')){
          delivered.checked = false;
        }
      }
      updateStates();
    });
    if(ready){
      ready.addEventListener('change', function(){
        if(!ready.checked){
          delivered.checked = false;
        }
        updateStates();
      });
    }
    finalized.addEventListener('change', function(){
      if(finalized.checked && !delivered.checked){
        alert('Finalized requires Delivered first.');
        finalized.checked = false;
      }
      updateStates();
    });
  }
  document.getElementById('add-fac').addEventListener('click', function(){
    var container = document.getElementById('additional-facilitators');
    var select = container.querySelector('select').cloneNode(true);
    select.value='';
    container.appendChild(select);
    refreshFacOptions();
  });
  function refreshFacOptions(){
    var lead = document.querySelector('select[name="lead_facilitator_id"]').value;
    document.querySelectorAll('#additional-facilitators select').forEach(function(sel){
      sel.querySelectorAll('option').forEach(function(opt){
        if(opt.value === lead){
          opt.style.display='none';
          if(sel.value === lead){ sel.value=''; }
        } else {
          opt.style.display='';
        }
      });
    });
  }
  document.querySelector('select[name="lead_facilitator_id"]').addEventListener('change', refreshFacOptions);
  refreshFacOptions();
  var clientSel = document.getElementById('client-select');
  function updateCRM(){
    var crm = clientSel.options[clientSel.selectedIndex] ? clientSel.options[clientSel.selectedIndex].dataset.crm || '' : '';
    document.getElementById('crm-display').textContent = crm;
  }
  updateCRM();
  clientSel.addEventListener('change', function(){
    updateCRM();
    var url = new URL(window.location.href);
    url.searchParams.set('client_id', this.value);
    var titleVal = document.querySelector('input[name="title"]').value;
    if(titleVal){ url.searchParams.set('title', titleVal); }
    else{ url.searchParams.delete('title'); }
    window.location = url.toString();
  });
  document.getElementById('include-all-fac').addEventListener('change', function(){
    var url = new URL(window.location.href);
    if(this.checked){ url.searchParams.set('include_all_facilitators','1'); }
    else{ url.searchParams.delete('include_all_facilitators'); }
    window.location = url.toString();
  });
  function nextUrl(){
    {% if session.id %}
    return '/sessions/{{ session.id }}/edit';
    {% else %}
    var cid = document.getElementById('client-select').value;
    return '/sessions/new?client_id='+cid;
    {% endif %}
  }
  document.getElementById('add-workshop-location').addEventListener('click', function(e){
    e.preventDefault();
    var cid = document.getElementById('client-select').value;
    if(!cid){ alert('Select client first'); return; }
    window.location = '/clients/'+cid+'/edit?section=workshop&next='+encodeURIComponent(nextUrl());
  });
  document.getElementById('add-client').addEventListener('click', function(e){
    e.preventDefault();
    window.location = '/clients/new?next='+encodeURIComponent(nextUrl());
  });
</script>
<script src="{{ url_for('static', filename='js/form_state.js') }}"></script>
{% endblock %}
