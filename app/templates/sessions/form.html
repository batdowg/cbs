{% extends 'base.html' %}
{% block title %}{{ 'New Session' if not session or not session.id else 'Edit Session' }}{% endblock %}
{% block content %}
<h1>{{ 'New Session' if not session or not session.id else 'Edit Session' }}</h1>
<form method="post">
  <fieldset>
    <legend>Order Information</legend>
    {% set _title = title_override if title_override is not none else session.title %}
    <div><label>Title* <input type="text" name="title" value="{{ _title or '' }}" required></label></div>
    <div><label>Client*
      <select name="client_id" id="client-select" required>
        <option value="">--Select--</option>
        {% for c in clients %}
        <option value="{{ c.id }}" {% if session and session.client_id==c.id %}selected{% endif %} data-crm="{% if c.crm %}{{ c.crm.full_name or c.crm.email }}{% endif %}">{{ c.name }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-client" class="button">Add Client</a> 
       &emsp;CRM: <span id="crm-display">{% if session and session.client and session.client.crm %}{{ session.client.crm.full_name or session.client.crm.email }}{% endif %}</span>
    </label>
    </div>
    <div><label>Region*
      <select name="region" required>
        <option value="">--Select--</option>
        {% for opt in ['NA','EU','SEA','Other'] %}
        <option value="{{ opt }}" {% if session and session.region==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
      &ensp;Workshop language*
      <select name="workshop_language" required>
        {% for code,label in workshop_languages %}
        <option value="{{ code }}" {% if session.workshop_language==code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div style="margin-top:8px;">
      <button type="submit" id="materials-only-btn" name="action" value="materials_only">No workshop, material order only</button>
    </div>
  </fieldset>
  <fieldset>
    <legend>Workshop details</legend>
    <div><label>Workshop*
      <select name="workshop_type_id" required>
        <option value="">--Select--</option>
        {% for wt in workshop_types %}
        <option value="{{ wt.id }}" data-langs="{{ wt.supported_languages|join(' ') if wt.supported_languages else '' }}" data-sim="{{ 1 if wt.simulation_based else 0 }}" {% if session and session.workshop_type_id==wt.id %}selected{% endif %}>{{ wt.code }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div id="sim-outline" {% if not (workshop_type and workshop_type.simulation_based) %}style="display:none"{% endif %}><label>{% if workshop_type and workshop_type.simulation_based %}Simulation Outline{% endif %}
      <select name="simulation_outline_id">
        <option value="">— select —</option>
        {% for o in simulation_outlines %}
          {% set so_val = form.simulation_outline_id|int if form else session.simulation_outline_id %}
          <option value="{{ o.id }}" {% if so_val == o.id %}selected{% endif %}>
            {{ o.number }} — {{ o.skill }} — {{ o.descriptor }} ({{ o.level }})
          </option>
        {% endfor %}
      </select></label></div>
    <div><label>Delivery Type*
      <select name="delivery_type" required>
        <option value="">--Select--</option>
        {% for opt in ['Onsite','Virtual','Self-paced','Hybrid'] %}
        <option value="{{ opt }}" {% if session and session.delivery_type==opt %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <label>Workshop Location
      <select name="workshop_location_id" id="workshop-location-select">
        <option value=""></option>
        {% for loc in workshop_locations %}
        <option value="{{ loc.id }}" {% if session.workshop_location_id==loc.id %}selected{% endif %}>{{ loc.label }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-workshop-location">Add</a>
    </label></div><br>
    <div><label>Capacity* <input type="number" name="capacity" value="{{ session.capacity or 16 }}" required></label></div>
    <div><label>Start Date* <input type="date" id="start-date" name="start_date" value="{{ session.start_date or '' }}" required></label>
    <input type="hidden" name="ack_past" id="ack-past" value="{{ form.ack_past if form else '' }}">
    <label>End Date* <input type="date" id="end-date" name="end_date" value="{{ session.end_date or '' }}" min="{{ session.start_date or '' }}" required></label><small>End date must be the same day or after the start date.</small></div>
    {% if past_warning %}
    <div style="color:red;"><label><input type="checkbox" id="ack-past-check" required> The selected start date is in the past. I'm sure.</label></div>
    {% endif %}
    <div><label>Daily Start Time <input type="time" name="daily_start_time" value="{{ daily_start_time_str or '08:00' }}"></label>  
    <label>End Time <input type="time" name="daily_end_time" value="{{ daily_end_time_str or '17:00' }}"></label></div>
    <div><label>Timezone
      <select name="timezone">
        <option value="">--Select--</option>
        {% for tz in timezones %}
        <option value="{{ tz }}" {% if session.timezone==tz %}selected{% endif %}>{{ tz }}</option>
        {% endfor %}
      </select>
    </label></div><br>
    <div><label>Lead Facilitator
      <select name="lead_facilitator_id">
        <option value="">--Select--</option>
        {% for u in facilitators %}
        <option value="{{ u.id }}" {% if session and session.lead_facilitator_id==u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label><input type="checkbox" id="include-all-fac" {% if include_all_facilitators %}checked{% endif %}> Include out-of-region facilitators</label></div>
    <div>Additional Facilitators:
      <div id="additional-facilitators">
        {% set adds = session.facilitators if session else [] %}
        {% if adds %}
          {% for fac in adds %}
          <select name="additional_facilitators">
            <option value="">--Select--</option>
            {% for u in facilitators %}
            <option value="{{ u.id }}" {% if u.id==fac.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
          {% endfor %}
        {% else %}
          <select name="additional_facilitators">
            <option value="">--Select--</option>
            {% for u in facilitators %}
            <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
      <button type="button" id="add-fac">Add another facilitator</button>
    </div><br>
    <div><label>Notes & Special instructions<br><textarea name="notes">{{ session.notes or '' }}</textarea></label></div><br>
  </fieldset>
  {% if session.id %}
  {% set disabled_all = session.cancelled or session.on_hold %}
  <fieldset>
    <legend>Lifecycle</legend>
    <div><label><input type="checkbox" name="materials_ordered" value="1" {% if session.materials_ordered %}checked{% endif %} {% if disabled_all %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all else 0 }}"> Materials ordered</label></div>
    {% set ready_base_disabled = disabled_all or participants_count==0 or session.delivered %}
    <div><label><input type="checkbox" name="ready_for_delivery" value="1" {% if session.ready_for_delivery %}checked{% endif %} {% if ready_base_disabled %}disabled{% endif %} data-base-disabled="{{ 1 if ready_base_disabled else 0 }}" title="{% if participants_count==0 %}Add participants before marking Ready for delivery.{% elif session.delivered %}Delivered is set{% endif %}"> Ready for delivery</label></div>
    <div><label><input type="checkbox" name="info_sent" value="1" {% if session.info_sent %}checked{% endif %} {% if disabled_all %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all else 0 }}"> Workshop info sent</label></div>
    {% set delivered_base_disabled = disabled_all or not session.ready_for_delivery or (session.end_date and session.end_date > today) %}
    <div>
      <label><input type="checkbox" name="delivered" value="1" {% if session.delivered %}checked{% endif %} {% if delivered_base_disabled %}disabled{% endif %} data-base-disabled="{{ 1 if delivered_base_disabled else 0 }}" title="{% if not session.ready_for_delivery %}Requires Ready for delivery{% elif session.end_date and session.end_date > today %}Cannot mark Delivered before the end date{% endif %}"> Delivered</label>
      {% if not delivered_base_disabled %}<input type="hidden" name="delivered" value="0">{% endif %}
    </div>
    <div><label><input type="checkbox" name="finalized" value="1" {% if session.finalized %}checked{% endif %} {% if disabled_all or not session.delivered %}disabled{% endif %} data-base-disabled="{{ 1 if disabled_all or not session.delivered else 0 }}" title="{% if not session.delivered %}Requires Delivered{% endif %}"> Finalized</label></div>
  </fieldset>
  <div>Status: <span class="badge">{{ session.computed_status }}</span></div>
  {% endif %}
  {% if not session or not session.id %}
  <button type="submit">Proceed to materials order</button>
  <button type="submit" name="action" value="no_material">No Materials Order (Save)</button>
  {% else %}
  <button type="submit">Save</button>
  {% endif %}
</form>
<dialog id="client-dialog">
  <form id="client-inline-form">
    <div><label>Name <input type="text" name="name" required></label></div>
    <div><label>SFC Link <input type="url" name="sfc_link"></label></div>
    <div><label>CRM
      <select name="crm_user_id">
        <option value=""></option>
        {% for u in users %}
        <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Data Region
      <select name="data_region">
        <option value=""></option>
        {% for opt in ['NA','EU','SEA','Other'] %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Status
      <select name="status">
        {% for opt in ['active','inactive'] %}
        <option value="{{ opt }}" {% if opt=='active' %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div style="margin-top:8px;">
      <button type="button" id="client-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<dialog id="location-dialog">
  <form id="location-inline-form">
    <div><label>Label <input type="text" name="label" required></label></div>
    <div><label>Virtual <input type="checkbox" name="is_virtual" value="1"></label></div>
    <div id="loc-platform-field"><label>Platform <input type="text" name="platform"></label></div>
    <div><label>Location access notes <input type="text" name="access_notes"></label></div>
    <div class="loc-address-field"><label>Address line 1 <input type="text" name="address_line1"></label></div>
    <div class="loc-address-field"><label>Address line 2 <input type="text" name="address_line2"></label></div>
    <div class="loc-address-field"><label>City <input type="text" name="city"></label></div>
    <div class="loc-address-field"><label>State <input type="text" name="state"></label></div>
    <div class="loc-address-field"><label>Postal Code <input type="text" name="postal_code"></label></div>
    <div class="loc-address-field"><label>Country <input type="text" name="country"></label></div>
    <div><label>Active <input type="checkbox" name="is_active" value="1" checked></label></div>
    <div style="margin-top:8px;">
      <button type="button" id="location-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<script>
  var langSelect = document.querySelector('select[name="workshop_language"]');
  var typeSelect = document.querySelector('select[name="workshop_type_id"]');
  var simDiv = document.getElementById('sim-outline');
  var materialsBtn = document.getElementById('materials-only-btn');
  if(materialsBtn){
    materialsBtn.addEventListener('click', function(){
      document.querySelectorAll('fieldset:not(:first-of-type) [required]').forEach(function(el){
        el.removeAttribute('required');
      });
    });
  }
  function filterTypes(){
    if(!langSelect || !typeSelect){ return; }
    var lang = langSelect.value;
    Array.from(typeSelect.options).forEach(function(opt){
      if(!opt.value){ return; }
      var langs = (opt.dataset.langs || '').split(' ');
      var show = langs.indexOf(lang) !== -1;
      opt.hidden = !show;
      if(!show && opt.selected){ opt.selected = false; }
    });
  }
  function toggleSim(){
    if(!typeSelect || !simDiv){ return; }
    var opt = typeSelect.options[typeSelect.selectedIndex];
    var isSim = opt && opt.dataset.sim === '1';
    simDiv.style.display = isSim ? 'block' : 'none';
    if(isSim){
      var lbl = simDiv.querySelector('label');
      if(lbl && !lbl.textContent.trim()){ lbl.insertAdjacentText('afterbegin','Simulation' + ' outline'); }
    }
  }
  filterTypes();
  toggleSim();
  if(langSelect){ langSelect.addEventListener('change', filterTypes); }
  if(typeSelect){ typeSelect.addEventListener('change', toggleSim); }
  var startField = document.getElementById('start-date');
  var endField = document.getElementById('end-date');
  var ackField = document.getElementById('ack-past');
  var prevStart = startField ? startField.value : '';
  function syncEndMin(){
    if(endField && startField){ endField.min = startField.value; }
  }
  if(startField && endField){
    syncEndMin();
    startField.addEventListener('change', function(){
      syncEndMin();
      ackField.value = '';
      var today = new Date().toISOString().slice(0,10);
      if(this.value && this.value < today){
        if(confirm('The selected start date is in the past. Continue?')){
          ackField.value = this.value;
        }else{
          this.value = prevStart;
          syncEndMin();
          return;
        }
      }
      prevStart = this.value;
    });
  }
  var ackCheck = document.getElementById('ack-past-check');
  if(ackCheck){
    ackCheck.addEventListener('change', function(){
      ackField.value = this.checked ? startField.value : '';
    });
  }
  var delivered = document.querySelector('input[name="delivered"]');
  var ready = document.querySelector('input[name="ready_for_delivery"]');
  var finalized = document.querySelector('input[name="finalized"]');
  var materials = document.querySelector('input[name="materials_ordered"]');
  var info = document.querySelector('input[name="info_sent"]');
  function updateStates(){
    if(delivered){
      if(delivered.checked){
        if(materials){ materials.checked = true; }
        if(info){ info.checked = true; }
        if(ready){ ready.disabled = true; }
      }else if(ready){
        ready.disabled = ready.dataset.baseDisabled === '1';
      }
      delivered.disabled = delivered.dataset.baseDisabled === '1' || (ready && !ready.checked);
    }
    if(finalized){
      if(finalized.checked){
        if(materials){ materials.disabled = true; }
        if(ready){ ready.disabled = true; }
        if(info){ info.disabled = true; }
        if(delivered){ delivered.disabled = true; }
      }else{
        if(materials){ materials.disabled = materials.dataset.baseDisabled === '1'; }
        if(ready){ ready.disabled = ready.dataset.baseDisabled === '1'; }
        if(info){ info.disabled = info.dataset.baseDisabled === '1'; }
        if(delivered){ delivered.disabled = delivered.dataset.baseDisabled === '1' || (ready && !ready.checked); }
      }
    }
  }
  if(delivered){
    updateStates();
    delivered.addEventListener('change', function(){
      if(delivered.checked){
        var end = document.querySelector('input[name="end_date"]').value;
        var today = new Date().toISOString().slice(0,10);
        if(!ready.checked){
          alert('Delivered requires "Ready for delivery" first.');
          delivered.checked = false;
        }else if(end && end > today){
          alert('Cannot mark Delivered before the end date.');
          delivered.checked = false;
        }else if(!confirm('Mark this session Delivered? Certificates become available.')){
          delivered.checked = false;
        }
      }
      updateStates();
    });
    if(ready){
      ready.addEventListener('change', function(){
        if(!ready.checked){
          delivered.checked = false;
        }
        updateStates();
      });
    }
    finalized.addEventListener('change', function(){
      if(finalized.checked && !delivered.checked){
        alert('Finalized requires Delivered first.');
        finalized.checked = false;
      }
      updateStates();
    });
  }
  document.getElementById('add-fac').addEventListener('click', function(){
    var container = document.getElementById('additional-facilitators');
    var select = container.querySelector('select').cloneNode(true);
    select.value='';
    container.appendChild(select);
    refreshFacOptions();
  });
  function refreshFacOptions(){
    var lead = document.querySelector('select[name="lead_facilitator_id"]').value;
    document.querySelectorAll('#additional-facilitators select').forEach(function(sel){
      sel.querySelectorAll('option').forEach(function(opt){
        if(opt.value === lead){
          opt.style.display='none';
          if(sel.value === lead){ sel.value=''; }
        } else {
          opt.style.display='';
        }
      });
    });
  }
  document.querySelector('select[name="lead_facilitator_id"]').addEventListener('change', refreshFacOptions);
  refreshFacOptions();
  var clientSel = document.getElementById('client-select');
  function updateCRM(){
    var crm = clientSel.options[clientSel.selectedIndex] ? clientSel.options[clientSel.selectedIndex].dataset.crm || '' : '';
    document.getElementById('crm-display').textContent = crm;
  }
  updateCRM();
  clientSel.addEventListener('change', function(){
    updateCRM();
    var cid = this.value;
    var locSel = document.getElementById('workshop-location-select');
    locSel.innerHTML = '<option value=""></option>';
    if(cid){
      fetch('/clients/'+cid+'/inline-workshop-locations')
        .then(r=>r.json())
        .then(data=>{
          data.locations.forEach(function(loc){
            var o=document.createElement('option');
            o.value=loc.id; o.textContent=loc.label; locSel.appendChild(o);
          });
        });
    }
  });
  document.getElementById('include-all-fac').addEventListener('change', function(){
    var url = new URL(window.location.href);
    if(this.checked){ url.searchParams.set('include_all_facilitators','1'); }
    else{ url.searchParams.delete('include_all_facilitators'); }
    window.location = url.toString();
  });
  function clearErrors(form){
    form.querySelectorAll('.error').forEach(el=>el.remove());
  }
  function showErrors(form, errors){
    for(var k in errors){
      var field=form.querySelector('[name="'+k+'"]');
      if(field){
        var div=document.createElement('div');
        div.className='error';
        div.textContent=errors[k];
        field.insertAdjacentElement('afterend', div);
      }
    }
  }
  var clientDialog = document.getElementById('client-dialog');
  var clientForm = document.getElementById('client-inline-form');
  document.getElementById('add-client').addEventListener('click', function(e){
    e.preventDefault();
    clientForm.reset();
    clearErrors(clientForm);
    clientDialog.showModal();
  });
  document.getElementById('client-cancel').addEventListener('click', function(){ clientDialog.close(); });
  clientForm.addEventListener('submit', function(e){
    e.preventDefault();
    clearErrors(clientForm);
    var fd=new FormData(clientForm);
    fetch('/clients/inline-new', {method:'POST', body:fd})
      .then(r=>r.json().then(data=>[r.status,data]))
      .then(([status,data])=>{
        if(status==200 && data.id){
          var o=document.createElement('option');
          o.value=data.id; o.textContent=data.name; if(data.crm){ o.dataset.crm=data.crm; }
          clientSel.appendChild(o);
          clientSel.value=data.id;
          clientDialog.close();
          clientSel.dispatchEvent(new Event('change'));
        }else if(data.errors){
          showErrors(clientForm, data.errors);
        }
      });
  });
  var locDialog = document.getElementById('location-dialog');
  var locForm = document.getElementById('location-inline-form');
  function toggleLocVirtual(){
    var cb = locForm.querySelector('input[name="is_virtual"]');
    var show = cb.checked;
    document.getElementById('loc-platform-field').style.display = show ? 'block' : 'none';
    locForm.querySelectorAll('.loc-address-field').forEach(function(el){ el.style.display = show ? 'none' : 'block'; });
  }
  locForm.querySelector('input[name="is_virtual"]').addEventListener('change', toggleLocVirtual);
  document.getElementById('add-workshop-location').addEventListener('click', function(e){
    e.preventDefault();
    if(!clientSel.value){ alert('Select client first'); return; }
    locForm.reset();
    clearErrors(locForm);
    toggleLocVirtual();
    locDialog.showModal();
  });
  document.getElementById('location-cancel').addEventListener('click', function(){ locDialog.close(); });
  locForm.addEventListener('submit', function(e){
    e.preventDefault();
    clearErrors(locForm);
    var cid=clientSel.value;
    var fd=new FormData(locForm);
    fetch('/clients/'+cid+'/inline-workshop-location', {method:'POST', body:fd})
      .then(r=>r.json().then(data=>[r.status,data]))
      .then(([status,data])=>{
        if(status==200 && data.id){
          var sel=document.getElementById('workshop-location-select');
          var o=document.createElement('option');
          o.value=data.id; o.textContent=data.label; sel.appendChild(o); sel.value=data.id;
          locDialog.close();
        }else if(data.errors){
          showErrors(locForm, data.errors);
        }
      });
  });
  toggleLocVirtual();
</script>
<script src="{{ url_for('static', filename='js/form_state.js') }}"></script>
{% endblock %}
