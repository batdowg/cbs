{% extends 'base.html' %}
{% block title %}{{ 'New Session' if not session else 'Edit Session' }}{% endblock %}
{% block content %}
{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}<ul class="flashes">{% for cat,msg in msgs %}<li class="{{cat}}">{{msg}}</li>{% endfor %}</ul>{% endif %}
{% endwith %}
<h1>{{ 'New Session' if not session else 'Edit Session' }}</h1>
<form method="post">
  <div><label>Title <input type="text" name="title" value="{{ session.title if session else '' }}"></label></div>
  <div><label>Workshop Type
    <select name="workshop_type_id" required>
      <option value="">--Select--</option>
      {% for wt in workshop_types %}
      <option value="{{ wt.id }}" {% if session and session.workshop_type_id==wt.id %}selected{% endif %}>{{ wt.code }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div><label>Start Date <input type="date" name="start_date" value="{{ session.start_date }}"></label></div>
  <div><label>End Date <input type="date" name="end_date" value="{{ session.end_date }}"></label></div>
  <div><label>Daily Start Time <input type="time" name="daily_start_time" value="{{ session.daily_start_time if session else '08:00' }}"></label></div>
  <div><label>Daily End Time <input type="time" name="daily_end_time" value="{{ session.daily_end_time if session else '17:00' }}"></label></div>
  <div><label>Timezone <input type="text" name="timezone" value="{{ session.timezone }}"></label></div>
  <div><label>Location <input type="text" name="location" value="{{ session.location }}"></label></div>
  <div><label>Delivery Type
    <select name="delivery_type">
      <option value="">--Select--</option>
      {% for opt in ['Onsite','Virtual','Self-paced','Hybrid'] %}
      <option value="{{ opt }}" {% if session and session.delivery_type==opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div><label>Region
    <select name="region">
      <option value="">--Select--</option>
      {% for opt in ['NA','EU','SEA','Other'] %}
      <option value="{{ opt }}" {% if session and session.region==opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div><label>Language
    <select name="language">
      {% for label, code in LANG_CHOICES %}
      <option value="{{ label }}" {% if (session and session.language==label) or (not session and label=='English') %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div><label>Capacity <input type="number" name="capacity" value="{{ session.capacity }}"></label></div>
  <div><label>Status
    <select name="status">
      {% for opt in STATUS_CHOICES %}
      <option value="{{ opt }}" {% if (session and session.status==opt) or (not session and opt=='New') %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div><label>Confirmed-Ready <input type="checkbox" name="confirmed_ready" value="y" {% if session and session.confirmed_ready %}checked{% endif %} {% if session and session.delivered %}disabled{% endif %}></label></div>
  <div><label>Delivered <input type="checkbox" name="delivered" value="y" {% if session and session.delivered %}checked{% endif %}></label></div>
  <div><label>Sponsor <input type="text" name="sponsor" value="{{ session.sponsor }}"></label></div>
  <div><label>Notes<br><textarea name="notes">{{ session.notes if session else '' }}</textarea></label></div>
  <div><label>Simulation Outline<br><textarea name="simulation_outline">{{ session.simulation_outline if session else '' }}</textarea></label></div>
  <div><label>Lead Facilitator
    <select name="lead_facilitator_id">
      <option value="">--Select--</option>
      {% for u in facilitators %}
      <option value="{{ u.id }}" {% if session and session.lead_facilitator_id==u.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
      {% endfor %}
    </select>
  </label></div>
  <div>Additional Facilitators:
    <div id="additional-facilitators">
      {% set adds = session.facilitators if session else [] %}
      {% if adds %}
        {% for fac in adds %}
        <select name="additional_facilitators">
          <option value="">--Select--</option>
          {% for u in facilitators %}
          <option value="{{ u.id }}" {% if u.id==fac.id %}selected{% endif %}>{{ u.full_name or u.email }}</option>
          {% endfor %}
        </select>
        {% endfor %}
      {% else %}
        <select name="additional_facilitators">
          <option value="">--Select--</option>
          {% for u in facilitators %}
          <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>
    <button type="button" id="add-fac">Add another facilitator</button>
  </div>
  <button type="submit">Save</button>
</form>
<script>
  var delivered = document.querySelector('input[name="delivered"]');
  var confirmed = document.querySelector('input[name="confirmed_ready"]');
  function syncDelivered(){
    if(delivered.checked){
      confirmed.checked = true;
      confirmed.disabled = true;
    } else {
      confirmed.disabled = false;
    }
  }
  delivered.addEventListener('change', function(){
    if(delivered.checked){
      if(!confirm('Mark this session Delivered? Certificates become available.')){
        delivered.checked = false;
        syncDelivered();
        return;
      }
    }
    syncDelivered();
  });
  document.querySelector('form').addEventListener('submit', function(){
    if(delivered.checked){
      confirmed.disabled = false;
      confirmed.checked = true;
    }
  });
  syncDelivered();
  document.getElementById('add-fac').addEventListener('click', function(){
    var container = document.getElementById('additional-facilitators');
    var select = container.querySelector('select').cloneNode(true);
    select.value='';
    container.appendChild(select);
    refreshFacOptions();
  });
  function refreshFacOptions(){
    var lead = document.querySelector('select[name="lead_facilitator_id"]').value;
    document.querySelectorAll('#additional-facilitators select').forEach(function(sel){
      sel.querySelectorAll('option').forEach(function(opt){
        if(opt.value === lead){
          opt.style.display='none';
          if(sel.value === lead){ sel.value=''; }
        } else {
          opt.style.display='';
        }
      });
    });
  }
  document.querySelector('select[name="lead_facilitator_id"]').addEventListener('change', refreshFacOptions);
  refreshFacOptions();
</script>
{% endblock %}
