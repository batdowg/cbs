{% extends 'base.html' %}
{% block title %}Materials Order<script>
  var orderType = document.querySelector('select[name="order_type"]');
  var materialSetsDiv = document.getElementById('material-sets');
  var creditsDiv = document.getElementById('credits-field');
  var simDiv = document.getElementById('simulation-outline');
  var simBase = creditsDiv ? creditsDiv.dataset.sim === '1' : false;
  function toggleExtras(ot){
    if(materialSetsDiv){ materialSetsDiv.style.display = (ot === 'Simulation') ? 'none' : ''; }
    if(creditsDiv){ var showC = (ot === 'Simulation') || simBase; creditsDiv.style.display = showC ? '' : 'none'; }
    if(simDiv){ var showS = (ot === 'Simulation') || simBase; simDiv.style.display = showS ? '' : 'none'; }
  }
  if(orderType){
    orderType.addEventListener('change', function(){ toggleExtras(this.value); });
    toggleExtras(orderType.value);
  }
</script>{% endblock %}
{% block content %}
{% set facs = [] %}
{% if sess.lead_facilitator %}{% set _ = facs.append(sess.lead_facilitator) %}{% endif %}
{% for fac in sess.facilitators %}{% set _ = facs.append(fac) %}{% endfor %}
<h1>Material Order {{ sess.id }} - {{ sess.title }} ({{ status }})</h1>
<nav class="kt-tabs">
  <a href="{{ url_for('sessions.session_detail', session_id=sess.id) }}">Details</a>
  {% if not sess.materials_only and sess.workshop_type %}
  <a href="{{ url_for('sessions.session_prework', session_id=sess.id) }}">Prework</a>
  {% endif %}
  <a href="{{ url_for('materials.materials_view', session_id=sess.id) }}" aria-current="page">Materials Order</a>
</nav>
<form method="post">
  <div class="kt-card form-align">
    <h2 class="kt-card-title">Order details</h2>
    {% set client_display = sess.client.name|default('', true) if sess.client else '' %}
    {% if sess.region %}{% set client_display = client_display ~ (', ' if client_display else '') ~ sess.region %}{% endif %}
    <div class="form-row">
      <label>Client</label>
      <div class="form-field">
        <span class="form-display">{{ client_display }}</span>
      </div>
    </div>
    <div class="form-row">
      <label>CRM</label>
      <div class="form-field">
        <span class="form-display">{% if sess.client and sess.client.crm %}{{ sess.client.crm.full_name or sess.client.crm.email }}{% endif %}</span>
      </div>
    </div>
    <div class="form-row">
      <label>Facilitator(s)</label>
      <div class="form-field">
        <span class="form-display">{% for u in facs %}{{ u.full_name or u.email }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
      </div>
    </div>
    {% set show_sfc_input = (not (sess.client and sess.client.sfc_link)) and not csa_view %}
    <div class="form-row">
      <label{% if show_sfc_input %} for="sfc-link"{% endif %}>SFC Project link</label>
      <div class="form-field">
        {% if sess.client and sess.client.sfc_link %}
          <span class="form-display">{{ sess.client.sfc_link }}</span>
        {% elif not csa_view %}
          <input type="url" id="sfc-link" name="sfc_link" value="{{ sess.client.sfc_link or '' }}">
        {% endif %}
      </div>
    </div>

    {% set show_arrival_input = can_edit_arrival and not readonly %}
    <div class="form-row">
      <label{% if show_arrival_input %} for="arrival-date"{% endif %}>Latest arrival date</label>
      <div class="form-field">
        {% if show_arrival_input %}
          <input type="date" id="arrival-date" name="arrival_date" value="{{ form.get('arrival_date') if form else (shipment.arrival_date.isoformat() if shipment.arrival_date else '') }}">
        {% else %}
          <span class="form-display">{{ shipment.arrival_date|default('', true) }}</span>
        {% endif %}
      </div>
    </div>
    <div class="form-row">
      <label>Order date</label>
      <div class="form-field">
        <span class="form-display">{{ shipment.created_at.date() if shipment.created_at else '' }}</span>
      </div>
    </div>
  </div>
  <div class="kt-card form-align">
    <h2 class="kt-card-title">Shipping details</h2>
    {% set can_edit_shipping = can_manage and not readonly %}
    <div class="form-row">
      <label{% if can_manage %} for="shipping-location-select"{% endif %}>Shipping location</label>
      <div class="form-field">
        {% if can_manage %}
          {% set loc_val = form.get('shipping_location_id') if form else sess.shipping_location_id %}
          <select name="shipping_location_id" id="shipping-location-select"{% if not can_edit_shipping %} disabled{% endif %}>
            <option value=""></option>
            {% for loc in shipping_locations %}

            <option value="{{ loc.id }}" data-contact="{{ loc.contact_name|default('', true) }}" data-email="{{ loc.contact_email|default('', true) }}" data-phone="{{ loc.contact_phone|default('', true) }}" data-address1="{{ loc.address_line1|default('', true) }}" data-address2="{{ loc.address_line2|default('', true) }}" data-city="{{ loc.city|default('', true) }}" data-state="{{ loc.state|default('', true) }}" data-postal="{{ loc.postal_code|default('', true) }}" data-country="{{ loc.country|default('', true) }}" {% if loc_val and loc_val|int==loc.id %}selected{% endif %}>{{ loc.title|default(loc.display_name(), true) }}</option>
            {% endfor %}
          </select>
          {% if can_edit_shipping and sess.client_id %}
          <a href="#" id="add-shipping-location" style="font-size:smaller">Add</a>
          <a href="{{ url_for('clients.edit_client', client_id=sess.client_id, section='shipping', next=url_for('materials.materials_view', session_id=sess.id)) }}" style="font-size:smaller">Edit locations</a>
          {% endif %}
        {% endif %}
        <div id="shipping-location-display" class="form-display form-display--block">

        {% if sess.shipping_location %}
          Attn: {{ sess.shipping_location.contact_name|default('', true) }}<br>
          {{ sess.shipping_location.address_line1|default('', true) }}{% if sess.shipping_location.address_line2 %} {{ sess.shipping_location.address_line2 }}{% endif %}<br>
          {{ sess.shipping_location.city|default('', true) }} {{ sess.shipping_location.state|default('', true) }} {{ sess.shipping_location.postal_code|default('', true) }}<br>
          {{ sess.shipping_location.country|default('', true) }}
        {% elif readonly %}
          Digital only
        {% endif %}

        </div>
      </div>
    </div>
    <div class="form-row">
      <label>Contact person</label>
      <div class="form-field">
        <span id="ship-contact-name" class="form-display">{{ shipment.contact_name|default('', true) }}</span>
      </div>
    </div>
    <div class="form-row">
      <label>Contact email</label>
      <div class="form-field">
        <span id="ship-contact-email" class="form-display">{{ shipment.contact_email|default('', true) }}</span>
      </div>
    </div>
    <div class="form-row">
      <label>Contact phone</label>
      <div class="form-field">
        <span id="ship-contact-phone" class="form-display">{{ shipment.contact_phone|default('', true) }}</span>
      </div>
    </div>
  </div>
  <div class="kt-card">
    <h2 class="kt-card-title">Order components</h2>
    <h3>{% if sess.workshop_type %}{{ sess.workshop_type.code }} — {{ sess.workshop_type.name }}{% endif %} ({{ sess.delivery_type|default('', true) }})</h3>
    <div class="form-align">
      {% set show_order_type_input = can_edit_materials_header('order_type', current_user, shipment) and not readonly %}
      <div class="form-align__row">
        {% if show_order_type_input %}
        <label class="form-align__label" for="order-type">Order type</label>
        {% else %}
        <span class="form-align__label">Order type</span>
        {% endif %}
        <div class="form-align__control">
          {% if show_order_type_input %}
            {% set ot_val = form.get('order_type') if form else shipment.order_type %}
            <select name="order_type" id="order-type">
              <option value="">— select —</option>
              {% for ot in order_types %}
                <option value="{{ ot }}" {% if ot_val==ot %}selected{% endif %}>{{ ot }}</option>
              {% endfor %}
            </select>
          {% else %}{{ shipment.order_type|default('', true) }}{% endif %}
        </div>
      </div>
      <div id="simulation-outline" class="form-align__row" {% if not show_sim_outline %}style="display:none"{% endif %}>
        <label class="form-align__label" for="simulation-outline-id">Simulation Outline</label>
        <div class="form-align__control">
          <select name="simulation_outline_id" id="simulation-outline-id" {% if outline_error %}class="field-error"{% endif %} data-error="{{ 1 if outline_error else 0 }}">
            <option value="">— select —</option>
            {% for o in simulation_outlines %}
              {% set so_val = form.get('simulation_outline_id') if form else sess.simulation_outline_id %}
              <option value="{{ o.id }}" {% if so_val|int==o.id %}selected{% endif %}>
                {{ o.number }} — {{ o.skill }} — {{ o.descriptor }} ({{ o.level }})
              </option>
            {% endfor %}
          </select>
          {% if outline_error %}
          <p class="form-help form-help--error">Simulation Outline is required for simulation-based workshops.</p>
          {% endif %}
        </div>
      </div>
      {% set show_materials_format_input = can_edit_materials_header('materials_format', current_user, shipment) and not readonly %}
      <div class="form-align__row">
        {% if show_materials_format_input %}
        <label class="form-align__label" for="materials-format">Material format</label>
        {% else %}
        <span class="form-align__label">Material format</span>
        {% endif %}
        <div class="form-align__control">
          {% if show_materials_format_input %}
            {% set fmt_val = form.get('materials_format') if form else fmt %}
            <select name="materials_format" id="materials-format">
              <option value=""></option>
              {% for key, label in material_formats %}
                <option value="{{ key }}" {% if fmt_val==key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          {% else %}{{ fmt|default('', true) }}{% endif %}
        </div>
      </div>
      <div id="material-sets" class="form-align__row" {% if shipment.order_type=='Simulation' %}style="display:none"{% endif %}>
        <label class="form-align__label" for="material-sets-input">Material Sets</label>
        <div class="form-align__control">
          <input type="number" id="material-sets-input" name="material_sets" min="0" value="{{ form.get('material_sets') if form else (shipment.material_sets or 0) }}">
        </div>
      </div>
      <div id="credits-field" class="form-align__row" data-sim="{{ 1 if sim_base else 0 }}" {% if not show_credits %}style="display:none"{% endif %}>
        <label class="form-align__label" for="credits"># of credits (2 teams per credit)</label>
        <div class="form-align__control">
          <input type="number" id="credits" name="credits" min="0" value="{{ form.get('credits') if form else (shipment.credits or 2) }}">
        </div>
      </div>
    </div>
    <div class="form-align_row">
      <label class="form-align__label" for="special_instructions">Special instructions:</label>
        {% if can_edit_materials_header('special_instructions', current_user, shipment) and not readonly %}      
          <div class="form-align_control">
            <textarea name="special_instructions">{{ (form.get('special_instructions') if form else (shipment.special_instructions or '')) | trim }}</textarea>
        {% else %}{{ shipment.special_instructions|default('', true) }}{% endif %}
      </div>
    </div>
  </div>

  <h2 class="kt-card-title", id="material-items">Material Items
  {% if can_manage %}
  {% set apply_disabled = shipment.order_type != 'KT-Run Standard materials' or (shipment.material_sets or 0) == 0 %}
  {% set tooltip = 'Select # of Material sets first.' if (shipment.material_sets or 0) == 0 else '' %}
  <button type="submit" id="apply-defaults-btn" form="defaults-form" class="btn btn-primary" {% if apply_disabled %}disabled{% endif %} {% if tooltip %}title="{{ tooltip }}"{% endif %}>Apply Defaults</button>
  {% endif %}</h2>
  {% if can_manage %}
  <p id="apply-outline-hint" class="form-help form-help--error" {% if not outline_error %}hidden{% endif %}>Choose a <a href="#simulation-outline">Simulation Outline</a> first.</p>
  {% endif %}
  <table class="kt-table" id="material-items-table" data-delivery="{{ sess.delivery_type }}" data-lang="{{ sess.workshop_language }}" data-capacity="{{ sess.capacity or 0 }}" data-default-formats='{{ default_formats | tojson }}'>
    <thead>
      <tr>
        <th scope="col">Materials</th>
        <th scope="col">Language</th>
        <th scope="col">Format</th>
        <th scope="col">Qty</th>
        <th scope="col">Processed</th>
        {% if can_manage %}<th scope="col">Actions</th>{% endif %}
      </tr>
    </thead>
    <tbody>
    {% if order_items %}
    {% for item in order_items %}
    <tr data-existing>
      <td>{{ item.title_snapshot }}
        <input type="hidden" name="items[{{ item.id }}][id]" value="{{ item.id }}">
        <input type="hidden" name="items[{{ item.id }}][option_id]" value="{{ item.catalog_ref.split(':')[1] if item.catalog_ref }}">
      </td>
      <td>
        {% if can_manage %}
        <select name="items[{{ item.id }}][language]" class="lang-select">
          {% for code,label in language_options %}
            <option value="{{ code }}" {% if item.language==code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% else %}
        {{ item.language | lang_label }}
        {% endif %}
      </td>
      <td>
        {% if can_manage %}
        <select name="items[{{ item.id }}][format]" class="fmt-select">
          {% for f in row_format_choices %}
            <option value="{{ f }}" {% if item.format==f %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
        {% else %}
        {{ item.format }}
        {% endif %}
      </td>
      {% if can_manage %}
      <td><input type="number" name="items[{{ item.id }}][quantity]" value="{{ item.quantity }}" class="qty-input" min="0" style="width:4em"></td>
      <td>
        <input type="checkbox" name="items[{{ item.id }}][processed]" value="1" {% if item.processed %}checked{% endif %}>
        {% if item.processed and item.processed_at %}
          <div>{{ item.processed_at.strftime('%Y-%m-%d %H:%M') }} UTC {{ (item.processed_by.full_name or item.processed_by.email) if item.processed_by }}</div>
        {% endif %}
      </td>
      <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button><input type="hidden" name="items[{{ item.id }}][delete]" value="0" class="delete-flag"></td>
      {% else %}
      <td>{{ item.quantity }}</td>
      <td>{% if item.processed and item.processed_at %}{{ item.processed_at.strftime('%Y-%m-%d %H:%M') }} UTC {{ (item.processed_by.full_name or item.processed_by.email) if item.processed_by }}{% endif %}</td>
      {% endif %}
    </tr>
    {% endfor %}
    {% else %}
      {% with colspan=(6 if can_manage else 5) %}

        {% include 'shared/_table_empty.html' %}

      {% endwith %}
    {% endif %}
    </tbody>
  </table>
  {% if can_manage %}
  <template id="item-row-template">
    <tr data-row="__index__">
      <td>
        <select name="items[__index__][option_id]" class="material-select">
          <option value=""></option>
        </select>
      </td>
      <td>
        <select name="items[__index__][language]" class="lang-select">
          {% for code,label in language_options %}
            <option value="{{ code }}" {% if code==sess.workshop_language %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select name="items[__index__][format]" class="fmt-select">
          <option value=""></option>
          {% for f in row_format_choices %}
            <option value="{{ f }}">{{ f }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" name="items[__index__][quantity]" class="qty-input" min="0" style="width:4em"></td>
      <td><input type="checkbox" name="items[__index__][processed]" value="1"></td>
      <td><button type="button" class="btn btn-sm btn-danger remove-row" style="display:none">Remove</button><input type="hidden" name="items[__index__][delete]" value="0" class="delete-flag"></td>
    </tr>
  </template>
  {% endif %}
  <div>Ship date:
    {% if can_edit_materials_header('ship_date', current_user, shipment) and not readonly %}
      <input type="date" name="ship_date" value="{{ form.get('ship_date') if form else (shipment.ship_date.isoformat() if shipment.ship_date else '') }}">
    {% else %}{{ shipment.ship_date|default('', true) }}{% endif %}
  Courier:
    {% if can_edit_materials_header('courier', current_user, shipment) and not readonly %}
      <input type="text" name="courier" value="{{ form.get('courier') if form else (shipment.courier or '') }}">
    {% else %}{{ shipment.courier|default('', true) }}{% endif %}
  Tracking:
    {% if can_edit_materials_header('tracking', current_user, shipment) and not readonly %}
      <input type="text" name="tracking" value="{{ form.get('tracking') if form else (shipment.tracking or '') }}">
    {% else %}{{ shipment.tracking|default('', true) }}{% endif %}
  </div>
  <button type="submit" name="action" value="update_header" class="btn btn-primary" {% if readonly %}disabled{% endif %}>Save</button>
  <button type="submit" name="action" value="finalize" class="btn btn-primary" {% if readonly %}disabled{% endif %}>Ready for Delivery/Finalized</button>
  {% if can_manage %}
  <p id="save-outline-hint" class="form-help form-help--error" {% if not outline_error %}hidden{% endif %}>Choose a <a href="#simulation-outline">Simulation Outline</a> first.</p>
  {% endif %}
  {% if is_staff_user %}
  <p style="margin-top:12px;color:var(--kt-muted);font-size:0.875rem;">Materials processors will be emailed when this order is created or updated.</p>
  {% endif %}
</form>
{% if can_manage %}
<form id="defaults-form" method="post" action="{{ url_for('materials.apply_defaults', session_id=sess.id) }}">
  <input type="hidden" name="materials_format" id="defaults-format">
</form>
{% endif %}
<dialog id="shipping-dialog">
  <form id="shipping-inline-form">
    <div><label>Title <input type="text" name="title"></label></div>
    <div><label>Contact Name <input type="text" name="contact_name"></label></div>
    <div><label>Contact Phone <input type="text" name="contact_phone"></label></div>
    <div><label>Contact Email <input type="email" name="contact_email"></label></div>
    <div><label>Shipping Notes <input type="text" name="notes"></label></div>
    <div><label>Address line 1 <input type="text" name="address_line1" required></label></div>
    <div><label>Address line 2 <input type="text" name="address_line2"></label></div>
    <div><label>City <input type="text" name="city"></label></div>
    <div><label>State <input type="text" name="state"></label></div>
    <div><label>Postal Code <input type="text" name="postal_code"></label></div>
    <div><label>Country <input type="text" name="country"></label></div>
    <div><label>Active <input type="checkbox" name="is_active" value="1" checked></label></div>
    <div style="margin-top:8px;">
      <button type="button" id="shipping-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<script>
  (function(){
    const fmtSel = document.querySelector('select[name="materials_format"]');
    const orderSel = document.querySelector('select[name="order_type"]');
    const setsInput = document.querySelector('input[name="material_sets"]');
    const applyBtn = document.getElementById('apply-defaults-btn');
    const hiddenFmt = document.getElementById('defaults-format');
    const outlineSelect = document.getElementById('simulation-outline-id');
    const outlineHasError = outlineSelect?.dataset.error === '1';
    const creditsField = document.getElementById('credits-field');
    const isSimulationBased = creditsField ? creditsField.dataset.sim === '1' : false;
    const applyHint = document.getElementById('apply-outline-hint');
    const saveHint = document.getElementById('save-outline-hint');
    const saveBtn = document.querySelector('button[name="action"][value="update_header"]');
    const finalizeBtn = document.querySelector('button[name="action"][value="finalize"]');
    const saveInitialDisabled = !!(saveBtn && saveBtn.disabled);
    const finalizeInitialDisabled = !!(finalizeBtn && finalizeBtn.disabled);
    function syncFmt(){ if(hiddenFmt && fmtSel) hiddenFmt.value = fmtSel.value; }
    function applyAutoFormat(){
      if(!fmtSel) return;
      if(orderSel?.value === 'Simulation' && !fmtSel.value){
        fmtSel.value = 'SIM_ONLY';
      }
    }
    function outlineMissing(){
      return isSimulationBased && !(outlineSelect && outlineSelect.value);
    }
    function syncOutlineHints(outlineEmpty){
      if(!isSimulationBased){
        applyHint && applyHint.setAttribute('hidden', 'hidden');
        saveHint && saveHint.setAttribute('hidden', 'hidden');
        return;
      }
      if(outlineEmpty){
        applyHint && applyHint.removeAttribute('hidden');
        saveHint && saveHint.removeAttribute('hidden');
      } else {
        applyHint && applyHint.setAttribute('hidden', 'hidden');
        saveHint && saveHint.setAttribute('hidden', 'hidden');
      }
    }
    function refreshActions(){
      const outlineEmpty = outlineMissing();
      if(applyBtn){
        const sets = parseInt(setsInput?.value || '0', 10);
        const isStandard = orderSel?.value === 'KT-Run Standard materials';
        let disabled = !isStandard || sets === 0;
        let title = sets === 0 ? 'Select # of Material sets first.' : '';
        if(outlineEmpty){
          disabled = true;
          title = 'Choose a Simulation Outline first.';
        }
        applyBtn.disabled = disabled;
        applyBtn.title = title;
      }
      if(saveBtn && !saveInitialDisabled){
        saveBtn.disabled = outlineEmpty;
      }
      if(finalizeBtn && !finalizeInitialDisabled){
        finalizeBtn.disabled = outlineEmpty;
      }
      syncOutlineHints(outlineEmpty);
      syncFmt();
    }
    fmtSel && fmtSel.addEventListener('change', refreshActions);
    orderSel && orderSel.addEventListener('change', () => {applyAutoFormat(); refreshActions();});
    setsInput && setsInput.addEventListener('input', refreshActions);
    outlineSelect && outlineSelect.addEventListener('change', refreshActions);
    applyAutoFormat();
    refreshActions();
    if(outlineHasError && outlineSelect){
      outlineSelect.focus();
      outlineSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  })();
  var shipSel = document.getElementById('shipping-location-select');
  function updateShipDetails(){
    var opt = shipSel && shipSel.options[shipSel.selectedIndex];
    var nameEl = document.getElementById('ship-contact-name');
    var emailEl = document.getElementById('ship-contact-email');
    var phoneEl = document.getElementById('ship-contact-phone');
    var dispDiv = document.getElementById('shipping-location-display');
    if(opt && opt.value){
      nameEl.textContent = opt.dataset.contact || '';
      emailEl.textContent = opt.dataset.email || '';
      phoneEl.textContent = opt.dataset.phone || '';
      var lines = [];
      if(opt.dataset.contact){ lines.push('Attn: '+opt.dataset.contact); }
      if(opt.dataset.address1){
        var addr = opt.dataset.address1;
        if(opt.dataset.address2){ addr += ' '+opt.dataset.address2; }
        lines.push(addr);
      }
      var line2 = [opt.dataset.city, opt.dataset.state, opt.dataset.postal].filter(Boolean).join(' ');
      if(line2){ lines.push(line2); }
      if(opt.dataset.country){ lines.push(opt.dataset.country); }
      dispDiv.innerHTML = lines.join('<br>');
    } else {
      nameEl.textContent = '';
      emailEl.textContent = '';
      phoneEl.textContent = '';
      dispDiv.innerHTML = '';
    }
  }
  shipSel && shipSel.addEventListener('change', updateShipDetails);
  updateShipDetails();
  var shipBtn = document.getElementById('add-shipping-location');
  var clientId = {{ sess.client_id or 'null' }};
  if(shipBtn && clientId){
    var shipDialog = document.getElementById('shipping-dialog');
    var shipForm = document.getElementById('shipping-inline-form');
    function clearShipErrors(){ shipForm.querySelectorAll('.error').forEach(el=>el.remove()); }
    shipBtn.addEventListener('click', function(e){
      e.preventDefault();
      shipForm.reset();
      clearShipErrors();
      shipDialog.showModal();
    });
    document.getElementById('shipping-cancel').addEventListener('click', function(){ shipDialog.close(); });
    shipForm.addEventListener('submit', function(e){
      e.preventDefault();
      clearShipErrors();
      var fd=new FormData(shipForm);
      fetch('/clients/'+clientId+'/inline-shipping-location', {method:'POST', body:fd})
        .then(r=>r.json().then(data=>[r.status,data]))
        .then(([status,data])=>{
          if(status==200 && data.id){
            var o=document.createElement('option');
            o.value=data.id; o.textContent=data.title || data.display;
            o.dataset.contact = data.contact_name || '';
            o.dataset.email = data.contact_email || '';
            o.dataset.phone = data.contact_phone || '';
            o.dataset.address1 = data.address_line1 || '';
            o.dataset.address2 = data.address_line2 || '';
            o.dataset.city = data.city || '';
            o.dataset.state = data.state || '';
            o.dataset.postal = data.postal_code || '';
            o.dataset.country = data.country || '';
            shipSel.appendChild(o); shipSel.value=data.id;
            updateShipDetails();
            shipDialog.close();
          }else if(data.errors){
            for(var k in data.errors){
              var field=shipForm.querySelector('[name="'+k+'"]');
              if(field){
                var div=document.createElement('div');
                div.className='error';
                div.textContent=data.errors[k];
                field.insertAdjacentElement('afterend', div);
              }
            }
          }
        });
    });
  }
</script>
{% if can_manage %}<script src="{{ url_for('static', filename='js/material_items_inline.js') }}"></script>{% endif %}
{% endblock %}

