{% extends 'base.html' %}
{% block title %}Materials Order<script>
  var orderType = document.querySelector('select[name="order_type"]');
  var materialsDiv = document.getElementById('materials-type');
  var materialsSelect = document.getElementById('materials-option');
  var materialsInfo = document.getElementById('materials-option-info');
  function updateMaterialsInfo(){
    if(!materialsSelect || !materialsInfo) return;
    var labels = Array.from(materialsSelect.selectedOptions).map(o=>o.textContent);
    materialsInfo.textContent = labels.join(', ');
  }
  var materialSetsDiv = document.getElementById('material-sets');
  var creditsDiv = document.getElementById('credits-field');
  var simDiv = document.getElementById('sim-outline');
  var simBase = creditsDiv ? creditsDiv.dataset.sim === '1' : false;
  function toggleExtras(ot){
    if(materialSetsDiv){ materialSetsDiv.style.display = (ot === 'Simulation') ? 'none' : 'block'; }
    if(creditsDiv){ var showC = (ot === 'Simulation') || simBase; creditsDiv.style.display = showC ? 'block' : 'none'; }
    if(simDiv){ var showS = (ot === 'Simulation') || simBase; simDiv.style.display = showS ? 'block' : 'none'; }
  }
  if(orderType && materialsSelect){
    function loadOptions(ot){
      materialsSelect.innerHTML = '';
      materialsSelect.multiple = (ot === 'KT-Run Modular materials');
      if(ot !== 'KT-Run Modular materials'){
        var empty = document.createElement('option');
        empty.value = '';
        materialsSelect.appendChild(empty);
      }
      fetch(orderType.dataset.optionsUrl + '?order_type=' + encodeURIComponent(ot))
        .then(r => r.json())
        .then(data => {
          data.options.forEach(function(opt){
            var o = document.createElement('option');
            o.value = opt.id;
            o.textContent = opt.title;
            materialsSelect.appendChild(o);
          });
          if(materialsDiv){ materialsDiv.style.display = ot ? "block" : "none"; }
          updateMaterialsInfo();
        });
    }
    orderType.addEventListener('change', function(){
      loadOptions(this.value);
      toggleExtras(this.value);
    });
    materialsSelect.addEventListener('change', updateMaterialsInfo);
    updateMaterialsInfo();
    toggleExtras(orderType.value);
  }
</script>
{% endblock %}
{% block content %}
{% set facs = [] %}
{% if sess.lead_facilitator %}{% set _ = facs.append(sess.lead_facilitator) %}{% endif %}
{% for fac in sess.facilitators %}{% set _ = facs.append(fac) %}{% endfor %}
<h1>Material Order {{ sess.id }} - {{ sess.title }}</h1>
<form method="post">
  <input type="hidden" name="action" value="update_header">
  <div class="kt-card">
    <h2 class="kt-card-title">Order details</h2>
    <div>Client: {% if sess.client %}{{ sess.client.name }}{% endif %}{% if sess.region %}, {{ sess.region }}{% endif %}</div>
    <div>CRM: {% if sess.client and sess.client.crm %}{{ sess.client.crm.full_name or sess.client.crm.email }}{% endif %}</div>
    <div>Facilitator(s): {% for u in facs %}{{ u.full_name or u.email }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
    <div>SFC Project link:
      {% if sess.client and sess.client.sfc_link %}
        {{ sess.client.sfc_link }}
      {% elif not csa_view %}
        <input type="url" name="sfc_link" value="{{ sess.client.sfc_link or '' }}">
      {% endif %}
    </div>
  </div>
  <div class="kt-card">
    <h2 class="kt-card-title">Shipping details</h2>
  <div>Contact person: {{ shipment.contact_name|default('', true) }}</div>
  <div>Contact Email: {{ shipment.contact_email|default('', true) }}</div>
  <div>Contact Phone: {{ shipment.contact_phone|default('', true) }}</div>
  {% if shipment.address_line1 %}
  <div>Address: {{ shipment.address_line1 }}{% if shipment.address_line2 %} {{ shipment.address_line2 }}{% endif %}, {{ shipment.city }} {{ shipment.state }} {{ shipment.postal_code }}, {{ shipment.country }}</div>
  {% else %}
  <div>Digital only</div>
  {% endif %}
  <p>Status: {{ status }}</p>
  <div>Shipping location:
    {% if can_manage and not readonly %}
      {% set loc_val = form.get('shipping_location_id') if form else sess.shipping_location_id %}
      <select name="shipping_location_id" id="shipping-location-select">
        <option value=""></option>
        {% for loc in shipping_locations %}
        <option value="{{ loc.id }}" {% if loc_val and loc_val|int==loc.id %}selected{% endif %}>{{ loc.display_name() }}</option>
        {% endfor %}
      </select>
      {% if sess.client_id %}
      <a href="#" id="add-shipping-location" style="font-size:smaller">Add</a>
      <a href="{{ url_for('clients.edit_client', client_id=sess.client_id, section='shipping', next=url_for('materials.materials_view', session_id=sess.id)) }}" style="font-size:smaller">Edit locations</a>
      {% endif %}
    {% endif %}
    {% if sess.shipping_location %}
      {% if can_manage and not readonly %}<br>{% endif %}
      {{ sess.shipping_location.contact_name|default('', true) }}<br>
      {{ sess.shipping_location.address_line1|default('', true) }}{% if sess.shipping_location.address_line2 %} {{ sess.shipping_location.address_line2 }}{% endif %}<br>
      {{ sess.shipping_location.city|default('', true) }} {{ sess.shipping_location.state|default('', true) }} {{ sess.shipping_location.postal_code|default('', true) }}<br>
      {{ sess.shipping_location.country|default('', true) }}
    {% endif %}
  </div>
  </div>
  <br>
  <div class="kt-card">
    <h2 class="kt-card-title">Materials type &amp; components</h2>
    <div>Workshop Type: {% if sess.workshop_type %}{{ sess.workshop_type.code }} — {{ sess.workshop_type.name }}{% endif %}</div>
    <div>Delivery Type: {{ sess.delivery_type|default('', true) }}</div>
    <br>
    <div>Order type:
    {% if can_edit_materials_header('order_type', current_user, shipment) and not readonly %}
      {% set ot_val = form.get('order_type') if form else shipment.order_type %}
      <select name="order_type" data-options-url="{{ url_for('materials.options', session_id=sess.id) }}">
        <option value="">— select —</option>
        {% for ot in order_types %}
          <option value="{{ ot }}" {% if ot_val==ot %}selected{% endif %}>{{ ot }}</option>
        {% endfor %}
      </select>
    {% else %}{{ shipment.order_type|default('', true) }}{% endif %}
  </div>
  <div id="materials-type" {% if not (form.get('order_type') if form else shipment.order_type) %}style="display:none"{% endif %}>Materials type:
    {% if can_edit_materials_header('materials_option_id', current_user, shipment) and not readonly %}
      {% set opt_vals = [] %}
      {% if form %}
        {% set opt_vals = form.getlist('materials_option_id')|map('int')|list %}
      {% elif selected_options %}
        {% set opt_vals = selected_options|map(attribute='id')|list %}
      {% elif shipment.materials_option_id %}
        {% set opt_vals = [shipment.materials_option_id] %}
      {% endif %}
      <select name="materials_option_id" id="materials-option" {% if shipment.order_type=='KT-Run Modular materials' %}multiple{% endif %}>
        {% if shipment.order_type!='KT-Run Modular materials' %}<option value=""></option>{% endif %}
        {% for opt in materials_options %}
          <option value="{{ opt.id }}" {% if opt.id in opt_vals %}selected{% endif %}>{{ opt.title }}</option>
        {% endfor %}
      </select>
    {% else %}{{ selected_options|map(attribute='title')|join(', ') or shipment.materials_option.title | default('', true) }}{% endif %}

  </div>
  <div id="sim-outline" {% if not show_sim_outline %}style="display:none"{% endif %}>
    <label>Simulation Outline
      <select name="simulation_outline_id">
        <option value="">— select —</option>
        {% for o in simulation_outlines %}
          {% set so_val = form.get('simulation_outline_id') if form else sess.simulation_outline_id %}
          <option value="{{ o.id }}" {% if so_val|int==o.id %}selected{% endif %}>
            {{ o.number }} — {{ o.skill }} — {{ o.descriptor }} ({{ o.level }})
          </option>
        {% endfor %}
      </select>
    </label>
  </div>
  <div>
    <label>Material format
      {% if can_edit_materials_header('materials_format', current_user, shipment) and not readonly %}
        {% set fmt_val = form.get('materials_format') if form else fmt %}
        <select name="materials_format" id="materials-format">
          <option value=""></option>
          {% for key, label in material_formats %}
            <option value="{{ key }}" {% if fmt_val==key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      {% else %}{{ fmt|default('', true) }}{% endif %}
    </label>
  </div>
  <fieldset class="components">
    <legend>Physical components</legend>
    {% for key,label in physical_components %}
      <label>
        <input type="checkbox" name="components" value="{{ key }}"
               {% if key in selected_components %}checked{% endif %}
               {% if fmt in ['ALL_DIGITAL','SIM_ONLY'] %}disabled{% endif %}>
        {{ label }}
      </label><br>
    {% endfor %}
    {% if components_required and errors.get('components') %}
      <div class="error">Select physical components</div>
  {% endif %}
  </fieldset>
  <div>Order date:
    {% if can_edit_materials_header('order_date', current_user, shipment) and not readonly %}
      <input type="date" name="order_date" value="{{ form.get('order_date') if form else order_date_val }}">
    {% else %}{{ shipment.order_date|default('', true) }}{% endif %}
  </div>
  <div>Latest arrival date:
    {% if can_edit_materials_header('arrival_date', current_user, shipment) and not readonly %}
      <input type="date" name="arrival_date" value="{{ form.get('arrival_date') if form else (shipment.arrival_date.isoformat() if shipment.arrival_date else '') }}">
    {% else %}{{ shipment.arrival_date|default('', true) }}{% endif %}
  </div>
  <div>PO Number:
    {% if can_edit_materials_header('materials_po_number', current_user, shipment) and not readonly %}
      <input type="text" name="materials_po_number" value="{{ form.get('materials_po_number') if form else (shipment.materials_po_number or '') }}">
    {% else %}{{ shipment.materials_po_number|default('', true) }}{% endif %}
  </div>
  <div id="material-sets" {% if shipment.order_type=='Simulation' %}style="display:none"{% endif %}>
    <label>Material Sets
      <input type="number" name="material_sets" min="0" value="{{ form.get('material_sets') if form else (shipment.material_sets or 0) }}">
    </label>
  </div>
  <div id="credits-field" data-sim="{{ 1 if sim_base else 0 }}" {% if not show_credits %}style="display:none"{% endif %}>
    <label># of credits (2 teams per credit)
      <input type="number" name="credits" min="0" value="{{ form.get('credits') if form else (shipment.credits or 2) }}">
    </label>
  </div>
  </div>

  <div>Courier:
    {% if can_edit_materials_header('courier', current_user, shipment) and not readonly %}
      <input type="text" name="courier" value="{{ form.get('courier') if form else (shipment.courier or '') }}">
    {% else %}{{ shipment.courier|default('', true) }}{% endif %}
  </div>
  <div>Tracking:
    {% if can_edit_materials_header('tracking', current_user, shipment) and not readonly %}
      <input type="text" name="tracking" value="{{ form.get('tracking') if form else (shipment.tracking or '') }}">
    {% else %}{{ shipment.tracking|default('', true) }}{% endif %}
  </div>
  <div>Ship date:
    {% if can_edit_materials_header('ship_date', current_user, shipment) and not readonly %}
      <input type="date" name="ship_date" value="{{ form.get('ship_date') if form else (shipment.ship_date.isoformat() if shipment.ship_date else '') }}">
    {% else %}{{ shipment.ship_date|default('', true) }}{% endif %}
  </div>
  <div>Special instructions:
    {% if can_edit_materials_header('special_instructions', current_user, shipment) and not readonly %}
      <textarea name="special_instructions">{{ (form.get('special_instructions') if form else (shipment.special_instructions or '')) | trim }}</textarea>
    {% else %}{{ shipment.special_instructions|default('', true) }}{% endif %}
  </div>
  <div>
    <label>Status
      {% if can_manage and not readonly %}
        {% set st_val = form.get('status') if form else shipment.status %}
        <select name="status">
          {% for st in order_statuses %}
            <option value="{{ st }}" {% if st_val==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      {% else %}{{ status }}{% endif %}
    </label>
  </div>
  <button type="submit" {% if readonly %}disabled{% endif %}>Save</button>
</form>
<dialog id="shipping-dialog">
  <form id="shipping-inline-form">
    <div><label>Contact Name <input type="text" name="contact_name"></label></div>
    <div><label>Contact Phone <input type="text" name="contact_phone"></label></div>
    <div><label>Contact Email <input type="email" name="contact_email"></label></div>
    <div><label>Shipping Notes <input type="text" name="notes"></label></div>
    <div><label>Address line 1 <input type="text" name="address_line1" required></label></div>
    <div><label>Address line 2 <input type="text" name="address_line2"></label></div>
    <div><label>City <input type="text" name="city"></label></div>
    <div><label>State <input type="text" name="state"></label></div>
    <div><label>Postal Code <input type="text" name="postal_code"></label></div>
    <div><label>Country <input type="text" name="country"></label></div>
    <div><label>Active <input type="checkbox" name="is_active" value="1" checked></label></div>
    <div style="margin-top:8px;">
      <button type="button" id="shipping-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<script>
  (function(){
    const fmtSel = document.querySelector('select[name="materials_format"]');
    const orderSel = document.querySelector('select[name="order_type"]');
    const boxes = [...document.querySelectorAll('input[name="components"]')];
    function applyState(autoCheck = false){
      const fmt = fmtSel?.value || '';
      const disable = (fmt === 'ALL_DIGITAL' || fmt === 'SIM_ONLY');
      boxes.forEach(b => { b.disabled = disable; if(disable){ b.checked = false; } });
      if(autoCheck && fmt === 'ALL_PHYSICAL') boxes.forEach(b => b.checked = true);
    }
    function applyAutoFormat(){
      if(!fmtSel) return;
      if(orderSel?.value === 'Simulation' && !fmtSel.value){
        fmtSel.value = 'SIM_ONLY';
      }
      applyState();
    }
    fmtSel && fmtSel.addEventListener('change', () => applyState(true));
    orderSel && orderSel.addEventListener('change', applyAutoFormat);
    applyAutoFormat();
  })();
  var shipBtn = document.getElementById('add-shipping-location');
  var clientId = {{ sess.client_id or 'null' }};
  if(shipBtn && clientId){
    var shipDialog = document.getElementById('shipping-dialog');
    var shipForm = document.getElementById('shipping-inline-form');
    var shipSel = document.getElementById('shipping-location-select');
    function clearShipErrors(){ shipForm.querySelectorAll('.error').forEach(el=>el.remove()); }
    shipBtn.addEventListener('click', function(e){
      e.preventDefault();
      shipForm.reset();
      clearShipErrors();
      shipDialog.showModal();
    });
    document.getElementById('shipping-cancel').addEventListener('click', function(){ shipDialog.close(); });
    shipForm.addEventListener('submit', function(e){
      e.preventDefault();
      clearShipErrors();
      var fd=new FormData(shipForm);
      fetch('/clients/'+clientId+'/inline-shipping-location', {method:'POST', body:fd})
        .then(r=>r.json().then(data=>[r.status,data]))
        .then(([status,data])=>{
          if(status==200 && data.id){
            var o=document.createElement('option');
            o.value=data.id; o.textContent=data.display;
            shipSel.appendChild(o); shipSel.value=data.id;
            shipDialog.close();
          }else if(data.errors){
            for(var k in data.errors){
              var field=shipForm.querySelector('[name="'+k+'"]');
              if(field){
                var div=document.createElement('div');
                div.className='error';
                div.textContent=data.errors[k];
                field.insertAdjacentElement('afterend', div);
              }
            }
          }
        });
    });
  }
  </script>
<h3 id="material-items">Material Items</h3>
{% if can_manage %}
<form method="post" action="{{ url_for('materials.apply_defaults', session_id=sess.id) }}">
  <button type="submit" class="btn btn-primary">Apply Defaults</button>
</form>
{% endif %}
<table border="1" cellpadding="4" cellspacing="0" id="material-items-table">
  <tr><th>Materials</th><th>Language</th><th>Format</th><th>Qty</th>{% if can_manage %}<th></th>{% endif %}</tr>
  {% for item in order_items %}
  <tr data-item-id="{{ item.id }}" data-update-url="{{ url_for('materials.update_order_item_quantity', session_id=sess.id, item_id=item.id) }}" data-delete-url="{{ url_for('materials.delete_order_item', session_id=sess.id, item_id=item.id) }}">
    <td>{{ item.title_snapshot }}</td>
    <td>{{ item.language }}</td>
    <td>{{ item.format }}</td>
    {% if can_manage %}
    <td><input type="number" min="0" value="{{ item.quantity }}" class="qty-input" style="width:4em"></td>
    <td>
      <button type="button" class="btn btn-sm save-qty">Save</button>
      <button type="button" class="btn btn-sm btn-danger remove-item">Remove</button>
    </td>
    {% else %}
    <td>{{ item.quantity }}</td>
    {% endif %}
  </tr>
  {% endfor %}
</table>
{% if can_manage %}
<div id="material-item-add">
  <h4>Add item</h4>
  <input id="add-material-label" list="add-material-list" placeholder="Search..." style="min-width:20em">
  <input type="hidden" id="add-material-id">
  <datalist id="add-material-list"></datalist>
  <label><input type="checkbox" id="add-show-all"> Show all</label>
  <input type="number" id="add-material-qty" min="1" value="1" style="width:4em">
  <button type="button" id="add-material-btn" class="btn btn-primary btn-sm">Add</button>
</div>
{% endif %}


<script>
  var orderType = document.querySelector('select[name="order_type"]');
  var materialsDiv = document.getElementById('materials-type');
  var materialsSelect = document.getElementById('materials-option');
  var materialsInfo = document.getElementById('materials-option-info');
  if(orderType && materialsSelect){
    orderType.addEventListener('change', function(){
      var ot = this.value;
      materialsSelect.innerHTML = '<option value=""></option>';
      if(materialsInfo){ materialsInfo.innerHTML = ''; }
      if(!ot){
        if(materialsDiv){ materialsDiv.style.display = "none"; }
        return;
      }
      fetch(this.dataset.optionsUrl + '?order_type=' + encodeURIComponent(ot))
        .then(r => r.json())
        .then(data => {
          data.options.forEach(function(opt){
            var o = document.createElement('option');
            o.value = opt.id;
            o.textContent = opt.title;
            materialsSelect.appendChild(o);
          });
          if(materialsDiv){ materialsDiv.style.display = "block"; }
        });
    });
  }

  var addShowAll = document.getElementById('add-show-all');
  var addLabel = document.getElementById('add-material-label');
  var addId = document.getElementById('add-material-id');
  var addList = document.getElementById('add-material-list');
  var addQty = document.getElementById('add-material-qty');
  var addBtn = document.getElementById('add-material-btn');
  function populateAddOptions(){
    if(!addList) return;
    var params = new URLSearchParams();
    params.append('delivery_type', '{{ sess.delivery_type }}');
    params.append('lang', '{{ sess.workshop_language }}');
    if(addShowAll && addShowAll.checked) params.append('include_bulk','1');
    fetch('/workshop-types/material-options?' + params.toString()).then(r=>r.json()).then(function(data){
      addList.innerHTML = '';
      (data.items||[]).forEach(function(it){
        var opt = document.createElement('option');
        opt.value = it.label;
        opt.dataset.id = it.id;
        addList.appendChild(opt);
      });
    });
  }
  if(addList){
    populateAddOptions();
    if(addShowAll){ addShowAll.addEventListener('change', populateAddOptions); }
    addLabel.addEventListener('input', function(){
      var match = Array.prototype.find.call(addList.options, function(o){ return o.value === addLabel.value; });
      addId.value = match ? match.dataset.id : '';
    });
    if(addBtn){
      addBtn.addEventListener('click', function(){
        if(!addId.value || !addQty.value) return;
        fetch('{{ url_for('materials.add_order_item', session_id=sess.id) }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            option_id: addId.value,
            language: '{{ sess.workshop_language }}',
            format: document.getElementById('materials-format') ? document.getElementById('materials-format').value : 'Digital',
            quantity: addQty.value
          })
        }).then(function(r){ if(r.ok) window.location.reload(); });
      });
    }
  }

  document.querySelectorAll('#material-items-table .save-qty').forEach(function(btn){
    btn.addEventListener('click', function(){
      var tr = btn.closest('tr');
      var url = tr.dataset.updateUrl;
      var qty = tr.querySelector('.qty-input').value;
      fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({quantity: qty})}).then(function(r){ if(r.ok) window.location.reload(); });
    });
  });
  document.querySelectorAll('#material-items-table .remove-item').forEach(function(btn){
    btn.addEventListener('click', function(){
      var tr = btn.closest('tr');
      var url = tr.dataset.deleteUrl;
      fetch(url, {method:'POST'}).then(function(r){ if(r.ok) tr.remove(); });
    });
  });
</script>
{% endblock %}

