{% extends 'base.html' %}
{% block title %}Materials Order<script>
  var orderType = document.querySelector('select[name="order_type"]');
  var materialsDiv = document.getElementById('materials-type');
  var materialsSelect = document.getElementById('materials-option');
  var materialsInfo = document.getElementById('materials-option-info');
  if(orderType && materialsSelect){
    orderType.addEventListener('change', function(){
      var ot = this.value;
      materialsSelect.innerHTML = '<option value=""></option>';
      if(materialsInfo){ materialsInfo.innerHTML = ''; }
      if(!ot){
        if(materialsDiv){ materialsDiv.style.display = "none"; }
        return;
      }
      fetch(this.dataset.optionsUrl + '?order_type=' + encodeURIComponent(ot))
        .then(r => r.json())
        .then(data => {
          data.options.forEach(function(opt){
            var o = document.createElement('option');
            o.value = opt.id;
            o.textContent = opt.title;
            materialsSelect.appendChild(o);
          });
          if(materialsDiv){ materialsDiv.style.display = "block"; }
        });
    });
  }
</script>
{% endblock %}
{% block content %}
<h1>Materials Order for {{ sess.title }}</h1>
<p>Status: {{ status }}</p>
<form method="post">
  <input type="hidden" name="action" value="update_header">
  <div>Client: {% if sess.client %}{{ sess.client.name }}{% endif %}</div>
  <div>Delivery region: {{ sess.region|default('', true) }}</div>
  <div>Workshop start date: {{ sess.start_date|default('', true) }}</div>
  <div>SFC Project link:
    {% if sess.client and sess.client.sfc_link %}
      {{ sess.client.sfc_link }}
    {% elif not csa_view %}
      <input type="url" name="sfc_link" value="{{ sess.client.sfc_link or '' }}">
    {% endif %}
  </div>
  <div>Shipping location:
    {% if can_manage and not readonly %}
      {% set loc_val = form.get('shipping_location_id') if form else sess.shipping_location_id %}
      <select name="shipping_location_id">
        <option value=""></option>
        {% for loc in shipping_locations %}
        <option value="{{ loc.id }}" {% if loc_val and loc_val|int==loc.id %}selected{% endif %}>{{ loc.display_name() }}</option>
        {% endfor %}
      </select>
      {% if sess.client_id %}
      <a href="{{ url_for('clients.edit_client', client_id=sess.client_id, section='shipping', next=url_for('materials.materials_view', session_id=sess.id)) }}" style="font-size:smaller">Edit locations</a>
      {% endif %}
    {% endif %}
    {% if sess.shipping_location %}
      {% if can_manage and not readonly %}<br>{% endif %}
      {{ sess.shipping_location.contact_name|default('', true) }}<br>
      {{ sess.shipping_location.address_line1|default('', true) }}{% if sess.shipping_location.address_line2 %} {{ sess.shipping_location.address_line2 }}{% endif %}<br>
      {{ sess.shipping_location.city|default('', true) }} {{ sess.shipping_location.state|default('', true) }} {{ sess.shipping_location.postal_code|default('', true) }}<br>
      {{ sess.shipping_location.country|default('', true) }}
    {% endif %}
  </div>
  <div>Order type:
    {% if can_edit_materials_header('order_type', current_user, shipment) and not readonly %}
      {% set ot_val = form.get('order_type') if form else shipment.order_type %}
      <select name="order_type" data-options-url="{{ url_for('materials.options', session_id=sess.id) }}">
        <option value="">— select —</option>
        {% for ot in order_types %}
          <option value="{{ ot }}" {% if ot_val==ot %}selected{% endif %}>{{ ot }}</option>
        {% endfor %}
      </select>
    {% else %}{{ shipment.order_type|default('', true) }}{% endif %}
  </div>
  <div id="materials-type" {% if not (form.get('order_type') if form else shipment.order_type) %}style="display:none"{% endif %}>Materials type:
    {% if can_edit_materials_header('materials_option_id', current_user, shipment) and not readonly %}
      {% set opt_val = form.get('materials_option_id') if form else shipment.materials_option_id %}
      <select name="materials_option_id" id="materials-option">
        <option value=""></option>
        {% for opt in materials_options %}
          <option value="{{ opt.id }}" {% if opt_val and opt_val|int==opt.id %}selected{% endif %}>{{ opt.title }}</option>
        {% endfor %}
      </select>
    {% else %}{{ shipment.materials_option.title | default('', true) }}{% endif %}
    {% if selected_option %}
    <div id="materials-option-info"><small>{{ selected_option.title }}{% if selected_option.languages %} — {{ selected_option.languages | map(attribute='name') | join(', ') }}{% endif %}{% if selected_option.formats %} ({{ selected_option.formats|join(', ') }}){% endif %}</small></div>
    {% else %}<div id="materials-option-info"></div>{% endif %}
  </div>
  {% if show_sim_outline %}
  <div>
    <label>Simulation outline
      <select name="simulation_outline_id">
        <option value="">— select —</option>
        {% for o in simulation_outlines %}
          {% set so_val = form.get('simulation_outline_id') if form else sess.simulation_outline_id %}
          <option value="{{ o.id }}" {% if so_val|int==o.id %}selected{% endif %}>
            {{ o.number }} — {{ o.skill }} — {{ o.descriptor }} ({{ o.level }})
          </option>
        {% endfor %}
      </select>
    </label>
  </div>
  <div>Material format:
    {% if can_edit_materials_header('materials_format', current_user, shipment) and not readonly %}
      {% set fmt_val = form.get('materials_format') if form else fmt %}
      <select name="materials_format" id="materials-format">
        <option value=""></option>
        {% for key, label in material_formats %}
          <option value="{{ key }}" {% if fmt_val==key %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    {% else %}{{ fmt|default('', true) }}{% endif %}
  </div>

  {% endif %}
  <fieldset class="components">
    <legend>Physical components</legend>
    {% for key,label in physical_components %}
      <label>
        <input type="checkbox" name="components" value="{{ key }}"
               {% if key in selected_components %}checked{% endif %}
               {% if fmt in ['ALL_DIGITAL','SIM_ONLY'] %}disabled{% endif %}>
        {{ label }}
      </label><br>
    {% endfor %}
    {% if components_required and errors.get('components') %}
      <div class="error">Select physical components</div>
    {% endif %}
  </fieldset>
  <div>PO Number:
    {% if can_edit_materials_header('materials_po_number', current_user, shipment) and not readonly %}
      <input type="text" name="materials_po_number" value="{{ form.get('materials_po_number') if form else (shipment.materials_po_number or '') }}">
    {% else %}{{ shipment.materials_po_number|default('', true) }}{% endif %}
  </div>
  <div>Latest arrival date:
    {% if can_edit_materials_header('arrival_date', current_user, shipment) and not readonly %}
      <input type="date" name="arrival_date" value="{{ form.get('arrival_date') if form else (shipment.arrival_date.isoformat() if shipment.arrival_date else '') }}">
    {% else %}{{ shipment.arrival_date|default('', true) }}{% endif %}
  </div>
  <div>Courier:
    {% if can_edit_materials_header('courier', current_user, shipment) and not readonly %}
      <input type="text" name="courier" value="{{ form.get('courier') if form else (shipment.courier or '') }}">
    {% else %}{{ shipment.courier|default('', true) }}{% endif %}
  </div>
  <div>Tracking:
    {% if can_edit_materials_header('tracking', current_user, shipment) and not readonly %}
      <input type="text" name="tracking" value="{{ form.get('tracking') if form else (shipment.tracking or '') }}">
    {% else %}{{ shipment.tracking|default('', true) }}{% endif %}
  </div>
  <div>Ship date:
    {% if can_edit_materials_header('ship_date', current_user, shipment) and not readonly %}
      <input type="date" name="ship_date" value="{{ form.get('ship_date') if form else (shipment.ship_date.isoformat() if shipment.ship_date else '') }}">
    {% else %}{{ shipment.ship_date|default('', true) }}{% endif %}
  </div>
  <div>Special instructions:
    {% if can_edit_materials_header('special_instructions', current_user, shipment) and not readonly %}
      <textarea name="special_instructions">{{ (form.get('special_instructions') if form else (shipment.special_instructions or '')) | trim }}</textarea>
    {% else %}{{ shipment.special_instructions|default('', true) }}{% endif %}
  </div>
  <button type="submit" {% if readonly %}disabled{% endif %}>Save</button>
</form>
<script>
  (function(){
    const fmtSel = document.querySelector('select[name="materials_format"]');
    const boxes = [...document.querySelectorAll('input[name="components"]')];
    function applyState(){
      const fmt = fmtSel?.value || '';
      const disable = (fmt === 'ALL_DIGITAL' || fmt === 'SIM_ONLY');
      boxes.forEach(b => { b.disabled = disable; if(disable){ b.checked = false; } });
      if(fmt === 'ALL_PHYSICAL') boxes.forEach(b => b.checked = true);
    }
    fmtSel && (fmtSel.addEventListener('change', applyState), applyState());
  })();
  </script>
<h3>Items</h3>
<table border="1" cellpadding="4" cellspacing="0">
  <tr><th>Material</th><th>Qty</th><th>Notes</th>{% if can_manage %}<th></th>{% endif %}</tr>
  {% for item in shipment.items %}
  <tr>
    {% if can_manage %}
    <form method="post">
      <input type="hidden" name="action" value="update_item">
      <input type="hidden" name="item_id" value="{{ item.id }}">
      <td>
        <select name="material_id">
          <option value="">— select —</option>
          {% for m in materials %}
            <option value="{{ m.id }}" {% if item.material_id==m.id %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" name="quantity" min="1" value="{{ item.quantity }}"></td>
      <td><input type="text" name="notes" value="{{ item.notes or '' }}"></td>
      <td>
        <button type="submit">Update</button>
    </form>
    <form method="post" style="display:inline">
      <input type="hidden" name="action" value="delete_item">
      <input type="hidden" name="item_id" value="{{ item.id }}">
      <button type="submit">Delete</button>
    </form>
      </td>
    {% else %}
      <td>{{ item.material.name if item.material else '' }}</td>
      <td>{{ item.quantity }}</td>
      <td>{{ item.notes or '' }}</td>
      {% if can_manage %}<td></td>{% endif %}
    {% endif %}
  </tr>
  {% endfor %}
</table>
{% if can_manage %}
<h4>Add item</h4>
<form method="post">
  <input type="hidden" name="action" value="add_item">
  <select name="material_id">
    <option value="">— select —</option>
    {% for m in materials %}
      <option value="{{ m.id }}">{{ m.name }}</option>
    {% endfor %}
  </select>
  <input type="number" name="quantity" min="1">
  <input type="text" name="notes">
  <button type="submit">Add</button>
</form>
<form method="post">
  <input type="hidden" name="action" value="mark_shipped">
  <button type="submit">Mark Shipped</button>
</form>
{% endif %}
{% if can_mark_delivered %}
<form method="post">
  <input type="hidden" name="action" value="mark_delivered">
  <button type="submit">Mark Delivered</button>
</form>
{% endif %}
{% if can_manage and not shipment.delivered_at %}
<form method="post" onsubmit="return confirm('Delete shipment?');">
  <input type="hidden" name="action" value="delete">
  <button type="submit">Delete Shipment</button>
</form>
{% endif %}
<script>
  var orderType = document.querySelector('select[name="order_type"]');
  var materialsDiv = document.getElementById('materials-type');
  var materialsSelect = document.getElementById('materials-option');
  var materialsInfo = document.getElementById('materials-option-info');
  if(orderType && materialsSelect){
    orderType.addEventListener('change', function(){
      var ot = this.value;
      materialsSelect.innerHTML = '<option value=""></option>';
      if(materialsInfo){ materialsInfo.innerHTML = ''; }
      if(!ot){
        if(materialsDiv){ materialsDiv.style.display = "none"; }
        return;
      }
      fetch(this.dataset.optionsUrl + '?order_type=' + encodeURIComponent(ot))
        .then(r => r.json())
        .then(data => {
          data.options.forEach(function(opt){
            var o = document.createElement('option');
            o.value = opt.id;
            o.textContent = opt.title;
            materialsSelect.appendChild(o);
          });
          if(materialsDiv){ materialsDiv.style.display = "block"; }
        });
    });
  }
</script>
{% endblock %}

