{% extends 'base.html' %}
{% set workshop_code = session.workshop_type.code if session.workshop_type else '—' %}
{% set delivery_label = session.delivery_type or '—' %}
{% set status_label = session.computed_status %}
{% set workshop_heading = session.id ~ ' ' ~ session.title ~ ': ' ~ workshop_code ~ ' (' ~ delivery_label ~ ') - ' ~ status_label %}
{% block title %}{{ workshop_heading }}{% endblock %}
{% block content %}
<h1>{{ workshop_heading }}</h1>
<p><a href="{{ url_for('my_sessions.list_my_sessions') }}">Back to My Sessions</a></p>
{% if session.cancelled %}<div class="banner">Session cancelled.</div>{% endif %}
{% set facs = [] %}
{% if session.lead_facilitator %}{% set _ = facs.append(session.lead_facilitator) %}{% endif %}
{% if session.facilitators %}
  {% for fac in session.facilitators %}{% if fac not in facs %}{% set _ = facs.append(fac) %}{% endif %}{% endfor %}
{% endif %}
{% if session.materials_only %}
<div class="kt-card">
  <div class="empty-state">
    <p>Workshop features not available on materials-only sessions.</p>
  </div>
</div>
{% else %}
{% set workshop_return = url_for('workshops.workshop_view', session_id=session.id) %}
{% set can_manage_participants = not session.delivered and not session.participants_locked() %}
{% set import_input_id = 'participant-import-' ~ session.id %}
<section class="kt-card">
  <h2 class="kt-card-title">Workshop overview</h2>
  <div class="grid grid-2 gap-md">
    <div class="grid gap-sm">
      <div><strong>Client:</strong> {% if session.client %}{{ session.client.name }}{% else %}—{% endif %}</div>
      <div><strong>CRM:</strong> {% if session.client and session.client.crm %}{{ session.client.crm.full_name or session.client.crm.email }}{% else %}—{% endif %}</div>
      <div>
        <strong>Facilitator(s):</strong>
        {% if facs %}
          {% for u in facs %}{{ u.full_name or u.email }} ({{ u.email }}){% if not loop.last %}, {% endif %}{% endfor %}
        {% else %}
          —
        {% endif %}
      </div>
      <div>
        <strong>Workshop Location:</strong>
        {% if session.workshop_location %}
          {% if session.workshop_location.is_virtual %}
            {{ session.workshop_location.label }}
          {% else %}
            {{ session.workshop_location.address_line1 }}{% if session.workshop_location.address_line2 %}, {{ session.workshop_location.address_line2 }}{% endif %}, {{ session.workshop_location.city }} {{ session.workshop_location.state }} {{ session.workshop_location.postal_code }}, {{ session.workshop_location.country }}
          {% endif %}
        {% else %}
          —
        {% endif %}
      </div>
      <div><strong>Simulation:</strong> {{ session.simulation_outline.label if session.simulation_outline else '—' }}</div>
      <div><strong>Dates:</strong> {{ session.start_date }} to {{ session.end_date }}; {{ session.daily_start_time|fmt_time_range_with_tz(session.daily_end_time, session.timezone) }}</div>
      <div><strong>Workshop language:</strong> {{ session.workshop_language | lang_label }}</div>
    </div>
    <div class="grid gap-sm">
      <div><strong>Shipping Location:</strong> {{ session.shipping_location.display_name() if session.shipping_location else '—' }}</div>
      <div><strong>Notes:</strong> {{ session.notes or session.description or '—' }}</div>
      <div><strong>Materials ordered:</strong> {{ 'Yes' if session.materials_ordered else 'No' }}{% if session.materials_ordered_at %} ({{ session.materials_ordered_at|fmt_dt }}){% endif %}</div>
      <div><strong>Ready for delivery:</strong> {{ 'Yes' if session.ready_for_delivery else 'No' }}{% if session.ready_at %} ({{ session.ready_at|fmt_dt }}){% endif %}</div>
      <div><strong>Workshop info sent:</strong> {{ 'Yes' if session.info_sent else 'No' }}{% if session.info_sent_at %} ({{ session.info_sent_at|fmt_dt }}){% endif %}</div>
      <div><strong>Delivered:</strong> {{ 'Yes' if session.delivered else 'No' }}{% if session.delivered_at %} ({{ session.delivered_at|fmt_dt }}){% endif %}</div>
      <div><strong>Finalized:</strong> {{ 'Yes' if session.finalized else 'No' }}{% if session.finalized_at %} ({{ session.finalized_at|fmt_dt }}){% endif %}</div>
    </div>
  </div>
</section>

<section class="kt-card">
  <h2 class="kt-card-title">Participants</h2>
  {% if can_send_prework %}
  <form action="{{ url_for('sessions.send_prework', session_id=session.id) }}" method="post" style="margin-bottom: var(--space-3);">
    <input type="hidden" name="next" value="{{ workshop_return }}">
    <button type="submit" class="btn btn-secondary">Send prework to all not submitted</button>
  </form>
  {% endif %}
  {% if can_manage_participants %}
  <form action="{{ url_for('sessions.add_participant', session_id=session.id) }}" method="post">
    <input type="hidden" name="next" value="{{ workshop_return }}">
    <input type="text" name="full_name" placeholder="Full name">
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="title" placeholder="Title">
    <button type="submit" class="btn btn-secondary">Add Participant</button>
  </form>
  <form action="{{ url_for('sessions.import_csv', session_id=session.id) }}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ workshop_return }}">
    <input type="file" id="{{ import_input_id }}" name="file" accept=".csv" required style="display:none" onchange="this.form.submit()">
    <label for="{{ import_input_id }}" class="btn">Import CSV</label>
    <a href="{{ url_for('sessions.sample_csv', session_id=session.id) }}">Download sample CSV</a>
  </form>
  {% if import_errors %}
  <div>
    <p>Skipped lines:</p>
    <ul>
      {% for err in import_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% endif %}
  <table class="kt-table">
    <thead>
      <tr>
        <th scope="col">Full Name</th>
        <th scope="col">Email</th>
        <th scope="col">Title</th>
        <th scope="col">Prework</th>
        <th scope="col">Completion Date</th>
        <th scope="col">Certificate</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in participants %}
      <tr>
        <td>{{ row.participant.full_name }}{% if row.participant.account and row.participant.account.certificate_name %} ({{ row.participant.account.certificate_name }}){% endif %}</td>
        <td>{{ row.participant.email }}</td>
        <td>{{ row.participant.title }}</td>
        <td>
          {% set status = row.prework_status %}
          {% set is_waived = status and status.status == 'WAIVED' %}
          {% if status and status.is_submitted %}
            Submitted{% if status.completed_at %} ({{ status.completed_at.date() | fmt_dt }}){% endif %}
          {% else %}
            {% if is_waived %}
              Not submitted (waived)
            {% else %}
              Not submitted
            {% endif %}
            {% if can_send_prework and not is_waived %}
            <form action="{{ url_for('sessions.send_prework', session_id=session.id) }}" method="post" style="display:inline-block;margin-left:var(--space-2);">
              <input type="hidden" name="next" value="{{ workshop_return }}">
              <input type="hidden" name="participant_ids[]" value="{{ row.participant.id }}">
              <button type="submit" class="btn btn-secondary btn-sm">Send prework</button>
            </form>
            {% endif %}
          {% endif %}
        </td>
        <td>
          <form action="{{ url_for('sessions.generate_single', session_id=session.id, participant_id=row.participant.id) }}" method="post">
            <input type="hidden" name="next" value="{{ workshop_return }}">
            <input type="date" name="completion_date" value="{{ row.link.completion_date }}">
            <button type="submit" class="btn btn-secondary" name="action" value="save">Save</button>
            {% if session.delivered %}
            <button type="submit" class="btn btn-secondary" name="action" value="generate">Generate</button>
            {% endif %}
          </form>
        </td>
        <td>
          {% if row.pdf_path %}
            {% if badge_filename %}
              {% set badge_url = '/badges/' ~ badge_filename %}
              <a href="{{ badge_url }}" download><img src="{{ badge_url }}" alt="badge" style="height:20px;width:auto;vertical-align:middle;"></a>
              <a href="{{ badge_url }}" download>Badge</a>
            {% endif %}
            <a href="/certificates/{{ row.pdf_path }}">Certificate</a>
          {% endif %}
        </td>
        <td>
          {% if can_manage_participants %}
          <a href="{{ url_for('sessions.edit_participant', session_id=session.id, participant_id=row.participant.id, next=workshop_return) }}">Edit</a>
          <form action="{{ url_for('sessions.remove_participant', session_id=session.id, participant_id=row.participant.id) }}" method="post" style="display:inline">
            <input type="hidden" name="next" value="{{ workshop_return }}">
            <button type="submit"class="btn btn-secondary" background-color: #a52820 border-color: #a52820>Remove</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7">No participants added yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if session.delivered %}
  <form action="{{ url_for('sessions.generate_bulk', session_id=session.id) }}" method="post">
    <input type="hidden" name="next" value="{{ workshop_return }}">
    <button type="submit">Generate Certificates</button>
  </form>
  {% else %}
  <p>Certificates cannot be generated until session is marked Delivered.</p>
  {% endif %}
</section>

<section class="kt-card">
  <h2 class="kt-card-title">Resources (facilitators)</h2>
  {% if facilitator_resources %}
    <div class="resource-list">
      {% for r in facilitator_resources %}
        {% set public_url = r.public_url %}
        {% set filename = r.document_filename or (r.resource_value.rsplit('/', 1)[-1] if r.resource_value else '') %}
        {% set ext = filename.rsplit('.', 1)[-1]|lower if '.' in filename else '' %}
        {% set is_image = ext in ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'] %}
        {% set is_pdf = ext == 'pdf' %}
        <details class="resource-item" open>
          <summary class="resource-summary">{{ r.name }}</summary>
          <div class="resource-panel">
            <div class="resource-tile">
              {% if r.type == 'DOCUMENT' and public_url %}
                <a href="{{ public_url }}" download class="resource-file-link">
                  {% if is_image %}
                    <img src="{{ public_url }}" alt="" class="resource-thumb">
                  {% else %}
                    <span class="resource-icon" aria-hidden="true">
                      {% if is_pdf %}
                        📄
                      {% else %}
                        ⬇️
                      {% endif %}
                    </span>
                  {% endif %}
                  <span class="resource-file-text">
                    <span class="resource-file-name">{{ filename or r.name }}</span>
                    <span class="resource-file-meta">
                      {% if is_image %}
                        Download image
                      {% elif is_pdf %}
                        Download PDF
                      {% else %}
                        Download file
                      {% endif %}
                    </span>
                  </span>
                </a>
              {% else %}
                <span class="resource-icon" aria-hidden="true">🔗</span>
                {% if r.resource_value %}
                  <a href="{{ r.resource_value }}" target="_blank" rel="noopener" class="btn btn-secondary">Open resource</a>
                {% else %}
                  <span class="resource-file-name">No file uploaded.</span>
                {% endif %}
              {% endif %}
            </div>
            {% if r.description_html %}
              <div class="resource-description rich-text">
                {{ r.description_html | safe }}
              </div>
            {% endif %}
          </div>
        </details>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <p>No resources available.</p>
    </div>
  {% endif %}
</section>

{% include "sessions/_prework_summary.html" %}
{% endif %}
{% endblock %}
