{% extends "base.html" %}
{% block title %}Prework for {{ wt.name }}{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/trix/1.3.1/trix.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/trix/1.3.1/trix.js"></script>
{% endblock %}
{% block content %}
<h1>Prework for {{ wt.name }}</h1>
<div class="prework-toolbar" style="display:flex;gap:var(--space-4);flex-wrap:wrap;align-items:flex-end;">
  <form method="get" class="language-select" style="display:flex;flex-direction:column;gap:var(--space-1);">
    <label for="language">Language</label>
    <select id="language" name="lang" onchange="this.form.submit()">
      {% for code, label in language_options %}
        <option value="{{ code }}" {% if code == selected_language %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </form>
  <form method="post" data-copy-form data-has-questions="{{ 'true' if has_questions else 'false' }}" style="display:flex;gap:var(--space-3);flex-wrap:wrap;align-items:flex-end;">
    <input type="hidden" name="language" value="{{ selected_language }}">
    <input type="hidden" name="action" value="copy">
    <div style="display:flex;flex-direction:column;gap:var(--space-1);">
      <label for="copy-source-type">Copy from workshop</label>
      <select id="copy-source-type" name="source_type_id">
        {% for option in copy_sources %}
          <option value="{{ option.id }}" {% if option.id == wt.id %}selected{% endif %}>{{ option.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="display:flex;flex-direction:column;gap:var(--space-1);">
      <label for="copy-source-language">Language</label>
      <select id="copy-source-language" name="source_language"></select>
    </div>
    <button type="submit" class="btn btn-secondary">Copy</button>
  </form>
</div>
<form method="post">
  <input type="hidden" name="language" value="{{ selected_language }}">
  <label><input type="checkbox" name="is_active" value="1" {% if template and template.is_active %}checked{% endif %}> Active</label><br>
<label><input type="checkbox" name="require_completion" value="1" {% if template and template.require_completion %}checked{% endif %}> Require completion</label><br>
<label>Information</label><br>
<input type="hidden" id="info" name="info" value="{{ template.info_html|e if template else '' }}">
<trix-editor input="info"></trix-editor><br>
{% if show_empty_state %}
<div class="empty-state">
  <p>No prework for this language yet.</p>
</div>
{% endif %}
<table>
<tr><th>#</th><th>Question</th><th>Type</th><th>Min</th><th>Max</th></tr>
{% for i in range(1,11) %}
  {% set q = questions[i-1] if questions|length >= i else None %}
  <tr>
    <td>{{ i }}</td>
    <td>
      <input type="hidden" id="text_{{i}}" name="text_{{i}}" value="{{ q.text|e if q else '' }}">
      <trix-editor input="text_{{i}}"></trix-editor>
    </td>
    <td>
      <select name="kind_{{i}}" class="kind-select">
        <option value="TEXT" {% if not q or q.kind=='TEXT' %}selected{% endif %}>Long text</option>
        <option value="LIST" {% if q and q.kind=='LIST' %}selected{% endif %}>List</option>
      </select>
    </td>
    <td><input type="number" name="min_{{i}}" min="1" max="10" value="{{ q.min_items if q and q.min_items is not none else 3 }}" class="min-input"></td>
    <td><input type="number" name="max_{{i}}" min="1" max="10" value="{{ q.max_items if q and q.max_items is not none else 5 }}" class="max-input"></td>
  </tr>
{% endfor %}
</table>
<button type="submit">Save</button>
</form>
<script>
const copySources = {{ copy_sources|tojson }};
const copyForm = document.querySelector('[data-copy-form]');
const copyTypeSelect = document.getElementById('copy-source-type');
const copyLanguageSelect = document.getElementById('copy-source-language');

function updateCopyLanguageOptions() {
  if (!copyTypeSelect || !copyLanguageSelect) return;
  const selectedId = copyTypeSelect.value;
  const entry = copySources.find((item) => String(item.id) === String(selectedId));
  const previous = copyLanguageSelect.value;
  copyLanguageSelect.innerHTML = '';
  if (!entry) {
    return;
  }
  let hasSelection = false;
  entry.languages.forEach((lang, index) => {
    const option = document.createElement('option');
    option.value = lang.code;
    option.textContent = lang.label;
    copyLanguageSelect.appendChild(option);
    if (!hasSelection && lang.code === previous) {
      copyLanguageSelect.value = lang.code;
      hasSelection = true;
    }
    if (!hasSelection && index === 0) {
      copyLanguageSelect.value = lang.code;
    }
  });
}

if (copyTypeSelect && copyLanguageSelect) {
  copyTypeSelect.addEventListener('change', () => {
    updateCopyLanguageOptions();
  });
  updateCopyLanguageOptions();
}

if (copyForm) {
  copyForm.addEventListener('submit', (event) => {
    if (copyForm.dataset.hasQuestions === 'true') {
      const confirmed = window.confirm('Replace existing questions?');
      if (!confirmed) {
        event.preventDefault();
      }
    }
  });
}

for (const row of document.querySelectorAll('table tr')) {
  const kindSel = row.querySelector('.kind-select');
  if (!kindSel) continue;
  const minInput = row.querySelector('.min-input');
  const maxInput = row.querySelector('.max-input');
  function toggle() {
    const show = kindSel.value === 'LIST';
    minInput.style.display = show ? 'inline' : 'none';
    maxInput.style.display = show ? 'inline' : 'none';
  }
  kindSel.addEventListener('change', toggle);
  toggle();
}
</script>
{% endblock %}
