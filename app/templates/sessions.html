{% extends 'base.html' %}
{% block title %}Sessions{% endblock %}
{% block content %}
{% set breadcrumbs = [{'href': url_for('home'), 'label': 'Home'}, {'label': 'Workshops'}] %}
<h1>Workshops</h1>
{% include 'shared/_breadcrumbs.html' %}
<p><a class="btn btn-success" href="{{ url_for('sessions.new_session') }}">New Order</a>
{% if show_global %}
<a href="{{ url_for('sessions.list_sessions') }}">Hide Global Sessions</a></p>
{% else %}
<p><a href="{{ url_for('sessions.list_sessions', global=1) }}">Show Global Sessions</a></p>
{% endif %}

<form method="get">
  <input type="text" name="q" placeholder="Search" value="{{ params.get('q','') }}">
  <label>Status
    <select name="status">
      <option value="" {% if not params.get('status') %}selected{% endif %}></option>
      {% for opt in ['New','In Progress','Ready for Delivery','Delivered','Finalized','On Hold','Cancelled'] %}
      <option value="{{ opt }}" {% if params.get('status')==opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    &ensp;Region 
    <select name="region">
      <option value="" {% if not params.get('region') %}selected{% endif %}></option>
      {% for opt in ['NA','EU','SEA','Other'] %}
      <option value="{{ opt }}" {% if params.get('region')==opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    &ensp;Delivery Type 
    <select name="delivery_type">
      <option value="" {% if not params.get('delivery_type') %}selected{% endif %}></option>
      {% for opt in ['Onsite','Virtual','Self-paced','Hybrid'] %}
      <option value="{{ opt }}" {% if params.get('delivery_type')==opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
    &ensp;Start from <input type="date" name="start_from" value="{{ params.get('start_from','') }}"> to <input type="date" name="start_to" value="{{ params.get('start_to','') }}"></label>
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="dir" value="{{ direction }}">
  <button type="submit">Filter</button>
  <a href="{{ url_for('sessions.list_sessions') }}">Clear</a>
</form><br>

<div class="kt-table-wrapper">
<table class="kt-table">
  <tr>
    {% macro sort_link(label, field) -%}
      {% set dir = 'desc' if sort==field and direction=='asc' else 'asc' %}
      <a href="{{ url_for('sessions.list_sessions', sort=field, dir=dir, **base_params) }}">{{ label }}</a>
    {%- endmacro %}
    <th>{{ sort_link('Title','title') }}</th>
    <th>{{ sort_link('Client','client') }}</th>
    <th>{{ sort_link('Location','location') }}</th>
    <th>{{ sort_link('Workshop Type','workshop_type') }}</th>
    <th>{{ sort_link('Start Date','start_date') }}</th>
    <th>{{ sort_link('Status','status') }}</th>
    <th>{{ sort_link('Region','region') }}</th>
    <th>Actions</th>
  </tr>
  {% for s in sessions %}
  <tr>
    <td><a href="{{ url_for('sessions.session_detail', session_id=s.id) }}">{{ s.title }}</a></td>
    <td>{% if s.client %}{{ s.client.name }}{% endif %}</td>
    <td>{{ s.location }}</td>
    <td>{% if s.workshop_type %}{{ s.workshop_type.code }} â€” {{ s.workshop_type.name }}{% endif %}</td>
    <td>{{ s.start_date }}</td>
    <td>{{ s.computed_status }}</td>
    <td>{{ s.region }}</td>
    <td>
      {% if current_user and (current_user.is_app_admin or current_user.is_admin or current_user.is_kt_delivery or current_user.is_kt_contractor) %}
        <a href="{{ url_for('sessions.session_prework', session_id=s.id) }}">Prework</a>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>
</div>
{% endblock %}
