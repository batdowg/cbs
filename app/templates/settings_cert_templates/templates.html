{% extends 'base.html' %}
{% block title %}Template Mapping{% endblock %}
{% block content %}
<h1>Template Mapping for {{ series.name }} ({{ series.code }})</h1>
<div style="margin-bottom: 1em;">
  <form method="post" action="{{ url_for('settings_cert_templates.upload_pdfs', series_id=series.id) }}" enctype="multipart/form-data" style="display:inline;">
    <input type="file" id="pdf_files" name="files" accept=".pdf" multiple style="display:none" onchange="this.form.submit()">
    <button type="button" onclick="document.getElementById('pdf_files').click()">Upload certificate templates (PDFs)</button>
  </form>
  <form method="post" action="{{ url_for('settings_cert_templates.upload_badges', series_id=series.id) }}" enctype="multipart/form-data" style="display:inline; margin-left: 0.5em;">
    <input type="file" id="badge_files" name="files" accept=".webp" multiple style="display:none" onchange="this.form.submit()">
    <button type="button" onclick="document.getElementById('badge_files').click()">Upload badges (WEBP)</button>
  </form>
</div>
<form method="post">
  <table class="kt-table">
    <tr><th>Language</th><th>A4</th><th>Letter</th><th>Badge</th></tr>
    {% for code, name in languages %}
    <tr>
      <td>{{ name }}</td>
      {% for size in ['A4','LETTER'] %}
      <td>
        <select name="{{ code }}_{{ size }}">
          <option value=""></option>
          {% for file in files %}
            <option value="{{ file }}" {% if mapping.get((code, size)) == file %}selected{% endif %}>{{ file }}</option>
          {% endfor %}
        </select>
      </td>
      {% endfor %}
      <td>
        <select name="badge_{{ code }}">
          <option value="">— None —</option>
          {% for badge in badges %}
            <option value="{{ badge }}" {% if badge_mapping.get(code) == badge %}selected{% endif %}>{{ badge }}</option>
          {% endfor %}
        </select>
        {% set current_badge = badge_mapping.get(code) %}
        {% if current_badge %}
          <br><small><a href="/badges/{{ current_badge }}">Current file</a></small>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
  <h2>Layout</h2>
  {% for size in ['A4','LETTER'] %}
    {% set size_layout = layout[size] %}
    {% set details = size_layout['details'] %}
    <fieldset style="margin-bottom:1.5em;">
      <legend>{{ size }} layout</legend>
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;">
        {% for key, label in {'name':'Learner name','workshop':'Workshop name','date':'Completion date'}.items() %}
          <div>
            <label for="layout-{{ size }}-{{ key }}-font">{{ label }} font</label><br>
            <select id="layout-{{ size }}-{{ key }}-font" name="layout_{{ size }}_{{ key }}_font">
              {% for font_code, font_label in font_options %}
                <option value="{{ font_code }}" {% if size_layout[key]['font'] == font_code %}selected{% endif %}>{{ font_label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="layout-{{ size }}-{{ key }}-y">{{ label }} Y (mm)</label><br>
            <input id="layout-{{ size }}-{{ key }}-y" type="number" step="0.1" name="layout_{{ size }}_{{ key }}_y" value="{{ '%.1f'|format(size_layout[key]['y_mm']) }}">
          </div>
        {% endfor %}
      </div>
      <div style="margin-top:1em;">
        <label>
          <input type="checkbox" name="layout_{{ size }}_details_enabled" value="1" {% if details.enabled %}checked{% endif %}>
          Enable details panel
        </label>
      </div>
      <div style="margin-top:0.5em; display:flex; gap:12px; flex-wrap:wrap;">
        <div>
          <label for="layout-{{ size }}-details-side">Panel side</label><br>
          <select id="layout-{{ size }}-details-side" name="layout_{{ size }}_details_side">
            {% for side in detail_sides %}
              <option value="{{ side }}" {% if details.side == side %}selected{% endif %}>{{ side.title() }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="layout-{{ size }}-details-size-percent">Size %</label><br>
          <input
            id="layout-{{ size }}-details-size-percent"
            type="number"
            name="layout_{{ size }}_details_size_percent"
            min="{{ detail_size_min }}"
            max="{{ detail_size_max }}"
            step="1"
            value="{{ details.size_percent }}"
            style="max-width:6ch;"
          >
        </div>
        <div>
          <label for="layout-{{ size }}-details-variables">Panel variables</label><br>
          <select id="layout-{{ size }}-details-variables" name="layout_{{ size }}_details_variables" multiple size="{{ detail_variables|length }}" style="min-width:200px;">
            {% for var in detail_variables %}
              <option value="{{ var }}" {% if var in details.variables %}selected{% endif %}>{{ var.replace('_',' ')|title }}</option>
            {% endfor %}
          </select>
          <p class="form-help">
            Size % scales the details lines from 50% to 100% of current text size.<br>
            Labels are suppressed for Location and Dates.<br>
            Class days and Contact hours render on one line when both are selected.
          </p>
        </div>
      </div>
    </fieldset>
  {% endfor %}
  <p><button type="submit">Save</button></p>
</form>
{% endblock %}
