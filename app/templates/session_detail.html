{% extends 'base.html' %}
{% import 'macros/lifecycle.html' as lifecycle %}
{% block title %}Session {{ session.title }}{% endblock %}
{% block content %}
{% set highlight_lifecycle_fields = (not session.delivered) and (not session.finalized) %}
{% set highlight_delivered = session.delivered and not session.finalized %}
{% set workshop_code = session.workshop_type.code if session.workshop_type else '—' %}
{% set delivery_label = session.delivery_type or '—' %}
{% set status_label = session.computed_status %}
{% set workshop_heading = session.id ~ ' ' ~ session.title ~ ': ' ~ workshop_code ~ ' (' ~ delivery_label ~ ') - ' ~ status_label %}
{% set certificate_only = certificate_only_session|default(False) %}
{% set import_input_id = 'participant-import-' ~ session.id %}
<h1>{{ workshop_heading }}</h1>
{% if certificate_only %}
<div class="pill" style="margin: var(--space-2) 0; display:inline-block;">Certificate-only session</div>
{% endif %}
<p><a href="{{ url_for('sessions.list_sessions', **back_params) }}">Back to Sessions</a></p>
{% if session.cancelled %}<div class="banner">Session cancelled.</div>{% endif %}
{% set facs = [] %}
{% if session.lead_facilitator %}{% set _ = facs.append(session.lead_facilitator) %}{% endif %}
{% if session.facilitators %}
  {% for fac in session.facilitators %}{% if fac not in facs %}{% set _ = facs.append(fac) %}{% endif %}{% endfor %}
{% endif %}
{% if current_user and can_edit_session and not session.cancelled %}
<div class="inline-gap-sm" style="margin: var(--space-2) 0; display:flex; flex-wrap:wrap; gap:var(--space-2);">
  {% if not material_only_session and not session.ready_for_delivery %}
  <form action="{{ url_for('sessions.mark_ready', session_id=session.id) }}" method="post" style="display:inline">
    <button type="submit" class="btn btn-secondary">Ready for delivery</button>
  </form>
  {% endif %}
  {% if not material_only_session and not session.delivered %}
  <form action="{{ url_for('sessions.mark_delivered', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Are you sure? This can’t be undone.');">
    <button type="submit" class="btn btn-success">Delivered</button>
  </form>
  {% endif %}
  {% if session.delivered and not session.finalized %}
  <form action="{{ url_for('sessions.finalize_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Finalize session?');">
    <button type="submit" class="btn btn-primary">Finalize session</button>
  </form>
  {% endif %}
</div>
{% endif %}
<section class="kt-card">
  <h2 class="kt-card-title">Workshop overview</h2>
  <div class="grid grid-2 gap-md">
    <div class="grid gap-sm">
      <div><strong>Client:</strong> {% if session.client %}{{ session.client.name }}{% else %}—{% endif %}</div>
      <div><strong>CRM:</strong> {% if session.client and session.client.crm %}{{ session.client.crm.display_name or session.client.crm.email }}{% else %}—{% endif %}</div>
      <div>
        <strong>Facilitator(s):</strong>
        {% if facs %}
          {% for u in facs %}{{ u.display_name or u.email }} ({{ u.email }}){% if not loop.last %}, {% endif %}{% endfor %}
        {% else %}
          —
        {% endif %}
      </div>
      <div>
        <strong>Workshop Location:</strong>
        {% if session.workshop_location %}
          {% if session.workshop_location.is_virtual %}
            {{ session.workshop_location.label }}
          {% else %}
            {{ session.workshop_location.address_line1 }}{% if session.workshop_location.address_line2 %}, {{ session.workshop_location.address_line2 }}{% endif %}, {{ session.workshop_location.city }} {{ session.workshop_location.state }} {{ session.workshop_location.postal_code }}, {{ session.workshop_location.country }}
          {% endif %}
        {% else %}
          —
        {% endif %}
      </div>
      <div><strong>Simulation:</strong> {{ session.simulation_outline.label if session.simulation_outline else '—' }}</div>
      <div><strong>Dates:</strong> {{ session.start_date }} to {{ session.end_date }}; {{ session.daily_start_time|fmt_time_range_with_tz(session.daily_end_time, session.timezone) }}</div>
      <div><strong>Workshop language:</strong> {{ session.workshop_language | lang_label }}</div>
    </div>
    <div class="grid gap-sm">
      <div><strong>Shipping Location:</strong> {{ session.shipping_location.display_name() if session.shipping_location else '—' }}</div>
      <div><strong>Notes:</strong> {{ session.notes or session.description or '—' }}</div>
      <div><strong>Materials ordered:</strong> {{ lifecycle.yes_no(session.materials_ordered, highlight_lifecycle_fields)|safe }}{% if session.materials_ordered_at %} ({{ session.materials_ordered_at|fmt_dt }}){% endif %}</div>
      <div><strong>Ready for delivery:</strong> {{ lifecycle.yes_no(session.ready_for_delivery, highlight_lifecycle_fields)|safe }}{% if session.ready_at %} ({{ session.ready_at|fmt_dt }}){% endif %}</div>
      <div><strong>Workshop info sent:</strong> {{ lifecycle.yes_no(session.info_sent, highlight_lifecycle_fields)|safe }}{% if session.info_sent_at %} ({{ session.info_sent_at|fmt_dt }}){% endif %}</div>
      <div><strong>Delivered:</strong> {{ lifecycle.delivered(session.delivered, highlight_delivered, session.finalized)|safe }}{% if session.delivered_at %} ({{ session.delivered_at|fmt_dt }}){% endif %}</div>
      <div><strong>Finalized:</strong> {{ 'Yes' if session.finalized else 'No' }}{% if session.finalized_at %} ({{ session.finalized_at|fmt_dt }}){% endif %}</div>
    </div>
  </div>
</section>
{% if current_user %}
<p><a href="{{ url_for('sessions.edit_session', session_id=session.id) }}">Edit</a>
{% if not session.cancelled %}
<form action="{{ url_for('sessions.cancel_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Cancel session?');"><button type="submit">Cancel session</button></form>
{% elif current_user.is_admin or current_user.is_app_admin %}
<form action="{{ url_for('sessions.delete_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Delete session?');"><button type="submit">Delete session</button></form>
{% endif %}
</p>
<nav class="kt-tabs">
  <a href="{{ url_for('sessions.session_detail', session_id=session.id) }}" aria-current="page">Details</a>
  {% if not material_only_session and not certificate_only and session.workshop_type and (current_user.is_app_admin or current_user.is_admin or current_user.is_kt_delivery or current_user.is_kt_contractor) %}
  <a href="{{ url_for('sessions.session_prework', session_id=session.id) }}">Prework</a>
  {% endif %}
  {% if not certificate_only %}
  <a href="{{ url_for('materials.materials_view', session_id=session.id) }}">Materials Order</a>
  {% endif %}
</nav>
{% endif %}
{% if not material_only_session %}
{% set participants_return = url_for('sessions.session_detail', session_id=session.id) %}
<div>
  <h2>Client Session Administrator</h2>
  {% if session.csa_account %}
    <p>Current CSA: {{ session.csa_account.email }}
    <form action="{{ url_for('sessions.remove_csa', session_id=session.id) }}" method="post" style="display:inline"><button type="submit">Remove</button></form>
    </p>
  {% else %}
    <form action="{{ url_for('sessions.assign_csa', session_id=session.id) }}" method="post">
      <input type="email" name="email" required>
      <button type="submit">Assign</button>
    </form>
  {% endif %}
</div>
<div class="kt-card">
<h2 class="kt-card-title">Participants</h2>
{% if csa_view %}
  {% if csa_can_manage and not session.delivered and not session.participants_locked() %}
  <form action="{{ url_for('sessions.add_participant', session_id=session.id) }}" method="post" data-name-split="true">
    <input type="hidden" name="next" value="{{ participants_return }}">
    <input type="text" name="first_name" class="js-name-first" placeholder="First name" required>
    <input type="text" name="last_name" class="js-name-last" placeholder="Last name" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="title" placeholder="Title">
    {% if can_edit_company %}
    <div class="inline-gap-sm">
      <select id="participant-company-select-new"
              name="company_client_id"
              data-client-select
              aria-label="Company">
        <option value="" {% if not session.client_id %}selected{% endif %}>—</option>
        {% for client in client_options %}
        <option value="{{ client.id }}" {% if session.client_id == client.id %}selected{% endif %}>{{ client.name }}</option>
        {% endfor %}
      </select>
      <button type="button"
              class="btn btn-secondary btn-sm"
              data-add-client-trigger
              data-target-select="participant-company-select-new">+ Add client</button>
    </div>
    {% endif %}
    <button type="submit">Add Participant</button>
  </form>
  <form action="{{ url_for('sessions.import_csv', session_id=session.id) }}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ participants_return }}">
    <input type="file" id="{{ import_input_id }}" name="file" accept=".csv" required style="display:none" onchange="this.form.submit()">
    <div class="inline-gap-sm">
      <label for="{{ import_input_id }}" class="btn">Import CSV</label>
      <a href="{{ url_for('sessions.sample_csv', session_id=session.id) }}">Download sample CSV</a>
    </div>
  </form>
  {% if import_errors %}
  <div>
    <p>Skipped lines:</p>
    <ul>
      {% for err in import_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% elif not csa_can_manage %}
  <p>Participant changes closed.</p>
  {% endif %}
  <div class="kt-table-wrapper">
    <table class="kt-table">
      <thead>
        <tr>
          <th scope="col">Full Name</th>
          <th scope="col">Email</th>
          <th scope="col">Title</th>
          <th scope="col">Company</th>
          <th scope="col">Certificate</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if participants %}
        {% for row in participants %}
        <tr>
          <td>{{ row.participant.display_name }}{% if row.participant.account and row.participant.account.certificate_name %} ({{ row.participant.account.certificate_name }}){% endif %}</td>
          <td>{{ row.participant.email }}</td>
          <td>{{ row.participant.title }}</td>
          {% set link_company = row.link.company_client %}
          {% set company_label = link_company.name if link_company else (session.client.name if session.client else '') %}
          <td>{{ company_label or '—' }}</td>
          <td>
            {% if row.pdf_path %}
              {% if badge_filename %}
                {% set badge_url = '/badges/' ~ badge_filename %}
                <a href="{{ badge_url }}" download><img src="{{ badge_url }}" alt="badge" style="height:20px;width:auto;vertical-align:middle;"></a>
                <a href="{{ badge_url }}" download>Badge</a>
              {% endif %}
              <a href="/certificates/{{ row.pdf_path }}">Certificate</a>
              <div>
                <strong>BadgeNumber:</strong>
                <span>{{ row.certification_number or '—' }}</span>
              </div>
            {% endif %}
          </td>
          <td>
        {% if csa_can_manage and not session.delivered and not session.participants_locked() %}
        <a href="{{ url_for('sessions.edit_participant', session_id=session.id, participant_id=row.participant.id) }}">Edit</a>
        <form action="{{ url_for('sessions.remove_participant', session_id=session.id, participant_id=row.participant.id) }}" method="post" style="display:inline">
          <button type="submit">Remove</button>
        </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% else %}
          {% with colspan=6 %}

            {% include 'shared/_table_empty.html' %}

          {% endwith %}
        {% endif %}
      </tbody>
    </table>
  </div>
{% else %}
  {% if not session.delivered and not session.participants_locked() %}
  <form action="{{ url_for('sessions.add_participant', session_id=session.id) }}" method="post" data-name-split="true">
    <input type="hidden" name="next" value="{{ participants_return }}">
    <input type="text" name="first_name" class="js-name-first" placeholder="First name" required>
    <input type="text" name="last_name" class="js-name-last" placeholder="Last name" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="title" placeholder="Title">
    <button type="submit">Add Participant</button>
  </form>
    <form action="{{ url_for('sessions.import_csv', session_id=session.id) }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="next" value="{{ participants_return }}">
      <input type="file" id="{{ import_input_id }}" name="file" accept=".csv" required style="display:none" onchange="this.form.submit()">
      <div class="inline-gap-sm">
        <label for="{{ import_input_id }}" class="btn">Import CSV</label>
        <a href="{{ url_for('sessions.sample_csv', session_id=session.id) }}">Download sample CSV</a>
      </div>
    </form>
  {% if import_errors %}
  <div>
    <p>Skipped lines:</p>
    <ul>
      {% for err in import_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% endif %}
  {% set attendance_toggle_url = url_for('sessions.toggle_attendance', session_id=session.id) %}
  {% set attendance_mark_all_url = url_for('sessions.mark_all_attendance', session_id=session.id) %}
  <div class="attendance-manager"
       {% if can_manage_attendance %}
       data-attendance-table
       data-toggle-url="{{ attendance_toggle_url }}"
       data-mark-all-url="{{ attendance_mark_all_url }}"
       {% endif %}>
    <div class="attendance-notices" data-attendance-notices aria-live="polite"></div>
    {% if can_manage_attendance %}
    <div class="table-toolbar">
      <button type="button" class="btn btn-secondary" data-mark-all-attended>Mark all attended</button>
    </div>
    {% endif %}
    <div class="kt-table-wrapper">
      <table class="kt-table{% if attendance_days %} attendance-table{% endif %}">
        <thead>
          <tr>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Full Name</th>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Email</th>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Title</th>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Company</th>
            {% if attendance_days %}
            <th  style="text-align: center;" scope="colgroup" colspan="{{ attendance_days|length }}">Attendance</th>
            {% endif %}
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Completion Date</th>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Certificate</th>
            <th scope="col"{% if attendance_days %} rowspan="2"{% endif %}>Actions</th>
          </tr>
          {% if attendance_days %}
          <tr>
            {% for day in attendance_days %}
            <th style="text-align: center;" scope="col">Day {{ day }}</th>
            {% endfor %}
          </tr>
          {% endif %}
        </thead>
        <tbody>
          {% for row in participants %}
          <tr>
            <td>{{ row.participant.display_name }}<br>{% if row.participant.account and row.participant.account.certificate_name %} ({{ row.participant.account.certificate_name }}){% endif %}</td>
            <td>{{ row.participant.email }}</td>
            <td>{{ row.participant.title }}</td>
            {% set selected_company_id = row.link.company_client_id or session.client_id %}
            {% if can_edit_company %}
            <td>
              <div class="inline-gap-sm">
                <select id="participant-company-select-{{ row.participant.id }}"
                        name="company_client_id"
                        form="participant-form-{{ row.participant.id }}"
                        data-client-select
                        aria-label="Company for {{ row.participant.display_name or row.participant.email }}">
                  <option value="" {% if not selected_company_id %}selected{% endif %}>—</option>
                  {% for client in client_options %}
                  <option value="{{ client.id }}" {% if client.id == selected_company_id %}selected{% endif %}>{{ client.name }}</option>
                  {% endfor %}
                </select>
                <button type="button"
                        class="btn btn-secondary btn-sm"
                        data-add-client-trigger
                        data-target-select="participant-company-select-{{ row.participant.id }}">+ Add client</button>
              </div>
            </td>
            {% else %}
            {% set display_company = row.link.company_client.name if row.link.company_client else (session.client.name if session.client else '') %}
            <td>{{ display_company or '—' }}</td>
            {% endif %}
            {% if attendance_days %}
              {% set attendance = row.attendance if row.attendance is defined else {} %}
              {% for day in attendance_days %}
              <td class="attendance-cell">
                {% if can_manage_attendance %}
                <input type="checkbox"
                       class="attendance-checkbox"
                       data-attendance-checkbox
                       data-participant-id="{{ row.participant.id }}"
                       data-participant-name="{{ row.participant.display_name or row.participant.email }}"
                       data-day-index="{{ day }}"
                       aria-label="Day {{ day }} attendance for {{ row.participant.display_name or row.participant.email }}"
                       {% if attendance.get(day) %}checked{% endif %}>
                {% else %}
                  {{ 'Yes' if attendance.get(day) else '—' }}
                {% endif %}
              </td>
              {% endfor %}
            {% endif %}
            <td>
              <form action="{{ url_for('sessions.generate_single', session_id=session.id, participant_id=row.participant.id) }}" method="post" id="participant-form-{{ row.participant.id }}">
                <input type="date" name="completion_date" value="{{ row.link.completion_date }}">
                <button type="submit" name="action" value="save">Save</button>
                {% if session.delivered %}
                {% set has_full_attendance = row.has_full_attendance if row.has_full_attendance is defined else True %}
                <button type="submit"
                        name="action"
                        value="generate"
                        {% if not has_full_attendance %}disabled title="Enable by marking Full attendance"{% endif %}>Generate</button>
                {% endif %}
              </form>
            </td>
            <td>
              {% if row.pdf_path %}
                {% if badge_filename %}
                  {% set badge_url = '/badges/' ~ badge_filename %}
                  <a href="{{ badge_url }}" download><img src="{{ badge_url }}" alt="badge" style="height:20px;width:auto;vertical-align:middle;"></a>
                  <a href="{{ badge_url }}" download>Badge</a>
                {% endif %}
                <a href="/certificates/{{ row.pdf_path }}">Certificate</a>
                <div>
                  <small><strong>Badge#:</strong>
                  <span>{{ row.certification_number or '—' }}</span></small>
                </div>
              {% endif %}
            </td>
            <td>
              {% if not session.delivered and not session.participants_locked() %}
              <a href="{{ url_for('sessions.edit_participant', session_id=session.id, participant_id=row.participant.id) }}">Edit</a>
              <form action="{{ url_for('sessions.remove_participant', session_id=session.id, participant_id=row.participant.id) }}" method="post" style="display:inline">
                <button type="submit">Remove</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% if session.delivered %}
  <form action="{{ url_for('sessions.generate_bulk', session_id=session.id) }}" method="post">
      <div class="card-actions" style="margin-bottom: var(--space-3);">
    <button type="submit">Generate Certificates</button>
  </form>
  {% if can_edit_session %}

      <a class="btn btn-secondary" href="{{ url_for('sessions.export_certificates_zip', session_id=session.id) }}">Export all certificates (zip)</a>
    </div>
  {% endif %}
    {% else %}
    <p>Certificates cannot be generated until session is marked Delivered.</p>
    {% endif %}
    {% endif %}
  </div>
  {% if can_edit_company %}
  <dialog class="kt-modal" data-add-client-modal>
    <form data-add-client-form>
      <div class="form-field">
        <label>Name
          <input type="text" name="name" required>
        </label>
        <div class="error" data-error-for="name" hidden></div>
      </div>
      <div class="form-field">
        <label>Data Region
          <select name="data_region" required>
            <option value="">--Select--</option>
            {% for opt in ['NA','EU','SEA','Other'] %}
            <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="error" data-error-for="data_region" hidden></div>
      </div>
      <div class="form-field">
        <label><input type="checkbox" name="is_active" value="1" checked> Active</label>
      </div>
      <div class="error" data-error-for="__all__" hidden></div>
      <div class="inline-gap-sm">
        <button type="button" class="btn btn-secondary" data-add-client-cancel>Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </dialog>
  {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
  {{ super() }}
  {% if can_edit_company %}
  <script src="{{ url_for('static', filename='js/add_client_modal.js') }}" defer></script>
  {% endif %}
  <script src="{{ url_for('static', filename='js/attendance_controls.js') }}"></script>
  <script>
  (function() {
    const forms = document.querySelectorAll('form[data-name-split="true"]');
    if (!forms.length) {
      return;
    }
    const namePattern = /\s*\([^)]*\)/g;
    const splitName = function(value) {
      const cleaned = (value || '').replace(namePattern, '').trim();
      if (!cleaned) {
        return ['', ''];
      }
      const parts = cleaned.split(/\s+/);
      if (parts.length === 1) {
        return [parts[0], ''];
      }
      const last = parts.pop();
      const first = parts.join(' ').trim();
      return [first, last];
    };
    const maybeSplit = function(event) {
      const input = event.target;
      const form = input.closest('form[data-name-split="true"]');
      if (!form) {
        return;
      }
      const firstInput = form.querySelector('.js-name-first');
      const lastInput = form.querySelector('.js-name-last');
      if (!firstInput || !lastInput) {
        return;
      }
      const otherInput = input === firstInput ? lastInput : firstInput;
      if (otherInput.value.trim()) {
        return;
      }
      const [first, last] = splitName(input.value);
      if (first && !firstInput.value.trim()) {
        firstInput.value = first;
      }
      if (last && !lastInput.value.trim()) {
        lastInput.value = last;
      }
    };
    forms.forEach(function(form) {
      const firstInput = form.querySelector('.js-name-first');
      const lastInput = form.querySelector('.js-name-last');
      if (!firstInput || !lastInput) {
        return;
      }
      firstInput.addEventListener('blur', maybeSplit);
      lastInput.addEventListener('blur', maybeSplit);
    });
  })();
  </script>
{% endblock %}
