{% extends 'base.html' %}
{% block title %}Session {{ session.title }}{% endblock %}
{% block content %}
<h1>{{ session.title }}</h1>
<p><a href="{{ url_for('sessions.list_sessions', **back_params) }}">Back to Sessions</a></p>
{% if session.cancelled %}<div class="banner">Session cancelled.</div>{% endif %}
{% set facs = [] %}
{% if session.lead_facilitator %}{% set _ = facs.append(session.lead_facilitator) %}{% endif %}
{% for fac in session.facilitators %}{% set _ = facs.append(fac) %}{% endfor %}
{% if csa_view %}
<div>
  Client:         {% if session.client %}{{ session.client.name }}{% endif %};   CRM: {% if session.client and session.client.crm %}{{ session.client.crm.full_name or session.client.crm.email }}{% endif %}<br>
  Facilitator(s): {% for u in facs %}{{ u.full_name or u.email }} ({{ u.email }}){% if not loop.last %}, {% endif %}{% endfor %}<br><br>
  Workshop Type:  {% if session.workshop_type %}{{ session.workshop_type.code }} - {{ session.workshop_type.name }}{% endif %}<br>
  Simulation:     {{ session.simulation_outline.label if session.simulation_outline else '—' }}<br>
  Dates:         {{ session.start_date }} to {{ session.end_date }}; {{ session.daily_start_time|fmt_time_range_with_tz(session.daily_end_time, session.timezone) }}<br>
  Workshop language: {{ session.workshop_language | lang_label }}<br>
  Delivery Type: {{ session.delivery_type }}<br>
  Workshop Location: {% if session.workshop_location %}{% if session.workshop_location.is_virtual %}{{ session.workshop_location.label }}{% else %}{{ session.workshop_location.address_line1 }}{% if session.workshop_location.address_line2 %}, {{ session.workshop_location.address_line2 }}{% endif %}, {{ session.workshop_location.city }} {{ session.workshop_location.state }} {{ session.workshop_location.postal_code }}, {{ session.workshop_location.country }}{% endif %}{% endif %}<br>
  Shipping Location: {{ session.shipping_location.display_name() if session.shipping_location else '' }}<br>
  Notes:  {{ session.notes or session.description or '' }}<br>
  Status: {{ session.computed_status }}<br>
  Materials ordered : {{ ' Yes' if session.materials_ordered else 'No' }}{% if session.materials_ordered_at %} ({{ session.materials_ordered_at|fmt_dt }}){% endif %}<br>
  Ready for delivery: {{ 'Yes' if session.ready_for_delivery else 'No' }}{% if session.ready_at %} ({{ session.ready_at|fmt_dt }}){% endif %}<br>
  Workshop info sent: {{ 'Yes' if session.info_sent else 'No' }}{% if session.info_sent_at %} ({{ session.info_sent_at|fmt_dt }}){% endif %}<br>
  Delivered         : {{ 'Yes' if session.delivered else 'No' }}{% if session.delivered_at %} ({{ session.delivered_at|fmt_dt }}){% endif %}<br>
</div>
{% else %}
<div>
  Client:        {% if session.client %}{{ session.client.name }}{% endif %}  -  CRM: {% if session.client and session.client.crm %}{{ session.client.crm.full_name or session.client.crm.email }}{% endif %}<br>
  Facilitator(s): {% for u in facs %}{{ u.full_name or u.email }} ({{ u.email }}){% if not loop.last %}, {% endif %}{% endfor %}<br><br>
  Workshop Type: {% if session.workshop_type %}{{ session.workshop_type.code }}: {{ session.workshop_type.name }}{% endif %}<br>
  Simulation:    {{ session.simulation_outline.label if session.simulation_outline else '—' }}<br>
  Dates:         {{ session.start_date }} to {{ session.end_date }}; {{ session.daily_start_time|fmt_time_range_with_tz(session.daily_end_time, session.timezone) }}<br><br>
  Delivery Type: {{ session.delivery_type }}<br>
  Workshop Location: {% if session.workshop_location %}{% if session.workshop_location.is_virtual %}{{ session.workshop_location.label }}{% else %}{{ session.workshop_location.address_line1 }}{% if session.workshop_location.address_line2 %}, {{ session.workshop_location.address_line2 }}{% endif %}, {{ session.workshop_location.city }} {{ session.workshop_location.state }} {{ session.workshop_location.postal_code }}, {{ session.workshop_location.country }}{% endif %}{% endif %}<br>
  Shipping Location: {{ session.shipping_location.display_name() if session.shipping_location else '' }}<br>
  Notes:  {{ session.notes or session.description or '' }}<br><br>
  Status: {{ session.computed_status }}<br>
  Materials ordered:  {{ 'Yes' if session.materials_ordered else 'No' }}{% if session.materials_ordered_at %} ({{ session.materials_ordered_at|fmt_dt }}){% endif %}<br>
  Ready for delivery: {{ 'Yes' if session.ready_for_delivery else 'No' }}{% if session.ready_at %} ({{ session.ready_at|fmt_dt }}){% endif %}<br>
  Workshop info sent: {{ 'Yes' if session.info_sent else 'No' }}{% if session.info_sent_at %} ({{ session.info_sent_at|fmt_dt }}){% endif %}<br>
  Delivered:          {{ 'Yes' if session.delivered else 'No' }}{% if session.delivered_at %} ({{ session.delivered_at|fmt_dt }}){% endif %}<br>
  Finalized:          {{ 'Yes' if session.finalized else 'No' }}{% if session.finalized_at %} ({{ session.finalized_at|fmt_dt }}){% endif %}
</div>
{% endif %}
{% if current_user %}
<p><a href="{{ url_for('sessions.edit_session', session_id=session.id) }}">Edit</a>
{% if not session.cancelled %}
<form action="{{ url_for('sessions.cancel_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Cancel session?');"><button type="submit">Cancel session</button></form>
{% elif current_user.is_admin or current_user.is_app_admin %}
<form action="{{ url_for('sessions.delete_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Delete session?');"><button type="submit">Delete session</button></form>
{% endif %}
{% if session.delivered and not session.finalized and not session.cancelled %}
<form action="{{ url_for('sessions.finalize_session', session_id=session.id) }}" method="post" style="display:inline" onsubmit="return confirm('Finalize session?');"><button type="submit">Finalize session</button></form>
{% endif %}
 {% if current_user.is_app_admin or current_user.is_admin or current_user.is_kt_delivery or current_user.is_kt_contractor %}| <a href="{{ url_for('sessions.session_prework', session_id=session.id) }}">Prework</a>{% endif %}
 | <a href="{{ url_for('materials.materials_view', session_id=session.id) }}">Materials Order</a>
</p>
<div>
  <h2>Client Session Administrator</h2>
  {% if session.csa_account %}
    <p>Current CSA: {{ session.csa_account.email }}
    <form action="{{ url_for('sessions.remove_csa', session_id=session.id) }}" method="post" style="display:inline"><button type="submit">Remove</button></form>
    </p>
  {% else %}
    <form action="{{ url_for('sessions.assign_csa', session_id=session.id) }}" method="post">
      <input type="email" name="email" required>
      <button type="submit">Assign</button>
    </form>
  {% endif %}
</div>
{% endif %}
<h2>Participants</h2>
{% if csa_view %}
  {% if csa_can_manage and not session.delivered and not session.participants_locked() %}
  <form action="{{ url_for('sessions.add_participant', session_id=session.id) }}" method="post">
    <input type="text" name="full_name" placeholder="Full name">
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="title" placeholder="Title">
    <button type="submit">Add Participant</button>
  </form>
  <form action="{{ url_for('sessions.import_csv', session_id=session.id) }}" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".csv">
    <button type="submit">Import CSV</button>
    <a href="{{ url_for('sessions.sample_csv', session_id=session.id) }}">Download sample CSV</a>
  </form>
  {% if import_errors %}
  <div>
    <p>Skipped lines:</p>
    <ul>
      {% for err in import_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% elif not csa_can_manage %}
  <p>Participant changes closed.</p>
  {% endif %}
  <table border="1" cellpadding="4" cellspacing="0">
    <tr><th>Full Name</th><th>Email</th><th>Title</th><th>Certificate</th><th>Actions</th></tr>
    {% for row in participants %}
    <tr>
      <td>{{ row.participant.full_name }}{% if row.participant.account and row.participant.account.certificate_name %} ({{ row.participant.account.certificate_name }}){% endif %}</td>
      <td>{{ row.participant.email }}</td>
      <td>{{ row.participant.title }}</td>
      <td>
        {% if row.pdf_path %}
          {% if badge_filename %}
            {% set badge_url = '/badges/' ~ badge_filename %}
            <a href="{{ badge_url }}" download><img src="{{ badge_url }}" alt="badge" style="height:20px;width:auto;vertical-align:middle;"></a>
            <a href="{{ badge_url }}" download>Badge</a>
          {% endif %}
          <a href="/certificates/{{ row.pdf_path }}">Certificate</a>
        {% endif %}
      </td>
      <td>
    {% if csa_can_manage and not session.delivered and not session.participants_locked() %}
    <a href="{{ url_for('sessions.edit_participant', session_id=session.id, participant_id=row.participant.id) }}">Edit</a>
    <form action="{{ url_for('sessions.remove_participant', session_id=session.id, participant_id=row.participant.id) }}" method="post" style="display:inline">
      <button type="submit">Remove</button>
    </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
{% else %}
  {% if not session.delivered and not session.participants_locked() %}
  <form action="{{ url_for('sessions.add_participant', session_id=session.id) }}" method="post">
    <input type="text" name="full_name" placeholder="Full name">
    <input type="email" name="email" placeholder="Email" required>
    <input type="text" name="title" placeholder="Title">
    <button type="submit">Add Participant</button>
  </form>
  <form action="{{ url_for('sessions.import_csv', session_id=session.id) }}" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".csv">
    <button type="submit">Import CSV</button>
    <a href="{{ url_for('sessions.sample_csv', session_id=session.id) }}">Download sample CSV</a>
  </form>
  {% if import_errors %}
  <div>
    <p>Skipped lines:</p>
    <ul>
      {% for err in import_errors %}
      <li>{{ err }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% endif %}
  <table border="1" cellpadding="4" cellspacing="0">
    <tr><th>Full Name</th><th>Email</th><th>Title</th><th>Completion Date</th><th>Certificate</th><th>Actions</th></tr>
    {% for row in participants %}
    <tr>
      <td>{{ row.participant.full_name }}{% if row.participant.account and row.participant.account.certificate_name %} ({{ row.participant.account.certificate_name }}){% endif %}</td>
      <td>{{ row.participant.email }}</td>
      <td>{{ row.participant.title }}</td>
      <td>
        <form action="{{ url_for('sessions.generate_single', session_id=session.id, participant_id=row.participant.id) }}" method="post">
          <input type="date" name="completion_date" value="{{ row.link.completion_date }}">
          <button type="submit" name="action" value="save">Save</button>
          {% if session.delivered %}
          <button type="submit" name="action" value="generate">Generate</button>
          {% endif %}
        </form>
      </td>
      <td>
        {% if row.pdf_path %}
          {% if badge_filename %}
            {% set badge_url = '/badges/' ~ badge_filename %}
            <a href="{{ badge_url }}" download><img src="{{ badge_url }}" alt="badge" style="height:20px;width:auto;vertical-align:middle;"></a>
            <a href="{{ badge_url }}" download>Badge</a>
          {% endif %}
          <a href="/certificates/{{ row.pdf_path }}">Certificate</a>
        {% endif %}
      </td>
      <td>
        {% if not session.delivered and not session.participants_locked() %}
        <a href="{{ url_for('sessions.edit_participant', session_id=session.id, participant_id=row.participant.id) }}">Edit</a>
        <form action="{{ url_for('sessions.remove_participant', session_id=session.id, participant_id=row.participant.id) }}" method="post" style="display:inline">
          <button type="submit">Remove</button>
        </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
  {% if session.delivered %}
  <form action="{{ url_for('sessions.generate_bulk', session_id=session.id) }}" method="post">
    <button type="submit">Generate Certificates</button>
  </form>
  {% else %}
  <p>Certificates cannot be generated until session is marked Delivered.</p>
  {% endif %}
{% endif %}
{% endblock %}
