{% extends "base.html" %}
{% block title %}Mail & Notification{% endblock %}
{% block content %}
<div class="kt-card">
<h1 class="kt-card-title">Mail & Notification</h1>
<h2>SMTP Settings</h2>
<p>Updated: {{ settings.updated_at }}</p>
<form method="post" data-dirty-guard="true">
  <label>SMTP Host
  <input type="text" name="smtp_host" value="{{ settings.smtp_host or '' }}" autocomplete="off"></label>
  <label>SMTP Port
  <input type="number" name="smtp_port" value="{{ settings.smtp_port or '' }}" autocomplete="off"></label>
  <label>SMTP Auth User
  <input type="email" name="smtp_user" value="{{ settings.smtp_user or '' }}" autocomplete="off"></label>
  <label>Default From
  <input type="email" name="smtp_from_default" value="{{ settings.smtp_from_default or '' }}" autocomplete="off"></label>
  <label>From Name
  <input type="text" name="smtp_from_name" value="{{ settings.smtp_from_name or '' }}" autocomplete="off"></label>
  <label>Password <small>(leave blank to keep existing) </small>
  <input type="password" name="smtp_pass" autocomplete="new-password"></label>
  <label><input type="checkbox" name="use_tls" {% if settings.use_tls %}checked{% endif %}> Use TLS</label>
  <label><input type="checkbox" name="use_ssl" {% if settings.use_ssl %}checked{% endif %}> Use SSL</label>
  <button type="submit">Save</button>
</form>
<form method="post" action="{{ url_for('settings_mail.test_send') }}" data-dirty-guard-bypass="true">
  <button type="submit" data-dirty-guard-bypass="true">Send test email</button>
</form>

<h2>Processors</h2>
<p>Assign processors per region and processing type.</p>
<p class="form-help">Emails for materials orders are sent to the processors listed here, by Region and Processing Type.</p>
<form method="post" action="{{ url_for('settings_mail.save_processors') }}" id="proc-form" data-dirty-guard="true">
  <div class="kt-table-wrapper">
    <table class="kt-table">
      <thead>
        <tr><th scope="col">Region</th><th scope="col">Type</th><th scope="col">Processors</th></tr>
      </thead>
      <tbody>
        {% for code,label in regions %}
          {% for pt in processing_types %}
          <tr>
            <td>{{ label }}</td>
            <td>{{ pt }}</td>
            <td>
              <div class="proc-people" data-key="{{ code }}-{{ pt }}">
                {% for u in assignments.get((code, pt), []) %}
                <span class="chip"><input type="hidden" name="{{ code }}-{{ pt }}" value="{{ u.id }}"><span>{{ u.full_name or u.email }}</span><button type="button" class="chip-remove" aria-label="Remove">×</button></span>
                {% endfor %}
                <button type="button" class="add-proc-user btn-secondary btn-sm">Add</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  <button type="submit">Save Processors</button>
</form>
<dialog id="user-picker">
  <form method="dialog" class="user-picker-form">
    <p><small>Only Administrator users can be processors.</small></p>
    <input type="text" id="user-picker-search" placeholder="Search users">
    <div id="user-picker-options" class="user-picker-options">
      {% for u in users %}
      <label><input type="checkbox" value="{{ u.id }}" data-label="{{ u.full_name or u.email }}"> {{ u.full_name or u.email }}</label>
      {% endfor %}
    </div>
    <menu>
      <button value="cancel">Cancel</button>
      <button id="user-picker-add" value="default">Add</button>
    </menu>
  </form>
</dialog>
</div>
<script>
const picker=document.getElementById('user-picker');
const search=document.getElementById('user-picker-search');
const optionLabels=[...document.querySelectorAll('#user-picker-options label')];
let currentContainer=null;
function updateOptions(){
  if(!currentContainer){return;}
  const term=search.value.toLowerCase();
  const key=currentContainer.dataset.key;
  const selected=[...currentContainer.querySelectorAll('input[name="'+key+'"]')].map(i=>i.value);
  optionLabels.forEach(label=>{
    const cb=label.querySelector('input');
    const text=cb.dataset.label.toLowerCase();
    const match=text.includes(term);
    const already=selected.includes(cb.value);
    label.style.display=match && !already? '' : 'none';
    cb.checked=false;
  });
}
document.querySelectorAll('.add-proc-user').forEach(btn=>{
  btn.addEventListener('click',()=>{
    currentContainer=btn.closest('.proc-people');
    search.value='';
    updateOptions();
    picker.showModal();
  });
});
search.addEventListener('input',updateOptions);
document.getElementById('user-picker-add').addEventListener('click',()=>{
  const key=currentContainer.dataset.key;
  picker.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>{
    const id=cb.value;
    const label=cb.dataset.label;
    const span=document.createElement('span');
    span.className='chip';
    span.innerHTML='<input type="hidden" name="'+key+'" value="'+id+'"><span>'+label+'</span><button type="button" class="chip-remove" aria-label="Remove">×</button>';
    currentContainer.insertBefore(span,currentContainer.querySelector('.add-proc-user'));
    cb.checked=false;
  });
  picker.close();
});
document.querySelectorAll('.proc-people').forEach(container=>{
  container.addEventListener('click',e=>{
    if(e.target.classList.contains('chip-remove')){
      e.preventDefault();
      e.target.closest('.chip').remove();
    }
  });
});
</script>
{% endblock %}
