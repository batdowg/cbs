{% extends "base.html" %}
{% block title %}Mail & Notification{% endblock %}
{% block content %}
<div class="kt-card">
<h1 class="kt-card-title">Mail & Notification</h1>
<h2>SMTP Settings</h2>
<p>Updated: {{ settings.updated_at }}</p>
<form method="post">
  <label>SMTP Host
  <input type="text" name="smtp_host" value="{{ settings.smtp_host or '' }}" autocomplete="off"></label>
  <label>SMTP Port
  <input type="number" name="smtp_port" value="{{ settings.smtp_port or '' }}" autocomplete="off"></label>
  <label>SMTP Auth User
  <input type="email" name="smtp_user" value="{{ settings.smtp_user or '' }}" autocomplete="off"></label>
  <label>Default From
  <input type="email" name="smtp_from_default" value="{{ settings.smtp_from_default or '' }}" autocomplete="off"></label>
  <label>From Name
  <input type="text" name="smtp_from_name" value="{{ settings.smtp_from_name or '' }}" autocomplete="off"></label>
  <label>Password <small>(leave blank to keep existing) </small>
  <input type="password" name="smtp_pass" autocomplete="new-password"></label>
  <label><input type="checkbox" name="use_tls" {% if settings.use_tls %}checked{% endif %}> Use TLS</label>
  <label><input type="checkbox" name="use_ssl" {% if settings.use_ssl %}checked{% endif %}> Use SSL</label>
  <button type="submit">Save</button>
</form>
<form method="post" action="{{ url_for('settings_mail.test_send') }}">
  <button type="submit">Send test email</button>
</form>

<h2>Processors</h2>
<p>Assign processors per region and processing type.</p>
<form method="post" action="{{ url_for('settings_mail.save_processors') }}" id="proc-form">
  <table>
    <thead>
      <tr><th>Region</th><th>Type</th><th>Processors</th></tr>
    </thead>
    <tbody>
      {% for code,label in regions %}
        {% for pt in processing_types %}
        <tr>
          <td>{{ label }}</td>
          <td>{{ pt }}</td>
          <td>
            <div class="proc-people" data-key="{{ code }}-{{ pt }}">
              {% for u in assignments.get((code, pt), []) %}
              <div><input type="hidden" name="{{ code }}-{{ pt }}" value="{{ u.id }}">{{ u.full_name or u.email }} <button type="button" data-remove="{{ u.id }}">Remove</button></div>
              {% endfor %}
              <input type="text" class="proc-user-input" list="proc-user-options">
              <button type="button" class="add-proc-user">Add</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
  <datalist id="proc-user-options">
    {% for u in users %}
    <option data-id="{{ u.id }}" value="{{ u.full_name or u.email }}"></option>
    {% endfor %}
  </datalist>
  <button type="submit">Save Processors</button>
</form>
</div>
<script>
document.querySelectorAll('.proc-people').forEach(container=>{
  const input=container.querySelector('.proc-user-input');
  const addBtn=container.querySelector('.add-proc-user');
  const key=container.dataset.key;
  addBtn.addEventListener('click',function(e){
    e.preventDefault();
    const val=input.value.trim();
    if(!val){return;}
    const list=document.getElementById('proc-user-options');
    const opt=[...list.options].find(o=>o.value===val);
    if(!opt){return;}
    const id=opt.dataset.id;
    if(container.querySelector('input[name="'+key+'"][value="'+id+'"])'){
      input.value='';
      return;
    }
    const div=document.createElement('div');
    div.innerHTML='<input type="hidden" name="'+key+'" value="'+id+'">'+val+' <button type="button" data-remove="'+id+'">Remove</button>';
    container.insertBefore(div, input);
    input.value='';
  });
  container.addEventListener('click',function(e){
    if(e.target.dataset.remove){
      e.preventDefault();
      e.target.parentElement.remove();
    }
  });
});
</script>
{% endblock %}
