{% extends "base.html" %}
{% block title %}Mail & Notification{% endblock %}
{% block content %}
<div class="kt-card">
<h1 class="kt-card-title">Mail & Notification</h1>
<h2>SMTP Settings</h2>
<p>Updated: {{ settings.updated_at }}</p>
<form method="post">
  <label>SMTP Host
  <input type="text" name="smtp_host" value="{{ settings.smtp_host or '' }}" autocomplete="off"></label>
  <label>SMTP Port
  <input type="number" name="smtp_port" value="{{ settings.smtp_port or '' }}" autocomplete="off"></label>
  <label>SMTP Auth User
  <input type="email" name="smtp_user" value="{{ settings.smtp_user or '' }}" autocomplete="off"></label>
  <label>Default From
  <input type="email" name="smtp_from_default" value="{{ settings.smtp_from_default or '' }}" autocomplete="off"></label>
  <label>From Name
  <input type="text" name="smtp_from_name" value="{{ settings.smtp_from_name or '' }}" autocomplete="off"></label>
  <label>Password <small>(leave blank to keep existing) </small>
  <input type="password" name="smtp_pass" autocomplete="new-password"></label>
  <label><input type="checkbox" name="use_tls" {% if settings.use_tls %}checked{% endif %}> Use TLS</label>
  <label><input type="checkbox" name="use_ssl" {% if settings.use_ssl %}checked{% endif %}> Use SSL</label>
  <button type="submit">Save</button>
</form>
<form method="post" action="{{ url_for('settings_mail.test_send') }}">
  <button type="submit">Send test email</button>
</form>

<h2>Processors</h2>
<form method="post" action="{{ url_for('settings_mail.save_processors') }}" id="proc-form">
  <label>Region
    <select name="region" id="proc-region">
      {% for code,label in regions %}
      <option value="{{ code }}" {% if proc_region==code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Processing type
    <select name="processing_type" id="proc-type">
      {% for pt in processing_types %}
      <option value="{{ pt }}" {% if proc_type==pt %}selected{% endif %}>{{ pt }}</option>
      {% endfor %}
    </select>
  </label>
  <div>
    <label>People</label>
    <div id="proc-people">
      {% for u in proc_users %}
      <div><input type="hidden" name="user_ids" value="{{ u.id }}">{{ u.full_name or u.email }} <button type="button" data-remove="{{ u.id }}">Remove</button></div>
      {% endfor %}
      <input type="text" id="proc-user-input" list="proc-user-options">
      <datalist id="proc-user-options">
        {% for u in users %}
        <option data-id="{{ u.id }}" value="{{ u.full_name or u.email }}"></option>
        {% endfor %}
      </datalist>
      <button type="button" id="add-proc-user">Add</button>
    </div>
  </div>
  <button type="submit">Save Processors</button>
</form>
</div>
<script>
const regionSel=document.getElementById('proc-region');
const typeSel=document.getElementById('proc-type');
function reload(){
  const r=regionSel.value;const t=typeSel.value;
  const params=new URLSearchParams(window.location.search);
  params.set('proc_region',r);params.set('proc_type',t);
  window.location='?' + params.toString();
}
regionSel.addEventListener('change',reload);
typeSel.addEventListener('change',reload);
const addBtn=document.getElementById('add-proc-user');
const input=document.getElementById('proc-user-input');
const list=document.getElementById('proc-user-options');
const container=document.getElementById('proc-people');
addBtn.addEventListener('click',function(e){e.preventDefault();const val=input.value.trim();if(!val){return;}const opt=[...list.options].find(o=>o.value===val);if(!opt){return;}const id=opt.dataset.id;if(container.querySelector('input[name="user_ids"][value="'+id+'"])'){input.value='';return;}const div=document.createElement('div');div.innerHTML='<input type="hidden" name="user_ids" value="'+id+'">'+val+' <button type="button" data-remove="'+id+'">Remove</button>';container.insertBefore(div, input);input.value='';});
container.addEventListener('click',function(e){if(e.target.dataset.remove){e.preventDefault();e.target.parentElement.remove();}});
</script>
{% endblock %}
