{% extends 'base.html' %}
{% block title %}Material Only Order{% endblock %}
{% block content %}
<h1>Material Only Order</h1>
<form method="post">
  <fieldset>
    <legend>Session Info</legend>
    <div><label>Title <input type="text" name="title" required></label></div>
    <div><label>Client
      <select name="client_id" id="client-select" required>
        <option value=""></option>
        {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-client" class="button">Add Client</a>
    </label></div>
    <div><label>Region
      <select name="region" required>
        <option value=""></option>
        {% for code,label in regions %}
          <option value="{{ code }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Language
      <select name="language" id="lang-select" required>
        {% for code,label in languages %}
          <option value="{{ code }}" {% if code=='en' %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Workshop Type
      <select name="workshop_type_id" id="wt-select" required>
        <option value=""></option>
        {% for wt in workshop_types %}
          <option value="{{ wt.id }}" data-langs="{{ wt.supported_languages|join(' ') if wt.supported_languages else '' }}" data-sim="{{ 1 if wt.simulation_based else 0 }}" data-default-material="{{ wt.default_materials_option_id or '' }}">{{ wt.code }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div>Delivery Type: Material Order</div>
  </fieldset>
  <fieldset>
    <legend>Materials</legend>
    <div><label>Shipping location
      <select name="shipping_location_id" id="shipping-location-select">
        <option value=""></option>
        {% for loc in shipping_locations %}
          <option value="{{ loc.id }}" data-client="{{ loc.client_id }}">{{ loc.display_name() }}</option>
        {% endfor %}
      </select>
      <a href="#" id="add-shipping-location" style="display:none">Add</a>
      <a href="#" id="edit-shipping-locations" style="display:none">Edit locations</a>
    </label></div>
    <div><label>Order Type
      <select name="order_type" data-options-url="{{ url_for('materials_only.options') }}">
        {% for ot in order_types %}
          <option value="{{ ot }}" {% if ot=='Client-run Bulk order' %}selected{% endif %}>{{ ot }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div id="materials-type" style="display:none">Materials type:
      <select name="materials_option_id" id="materials-option"></select>
      <div id="materials-option-info" style="font-size:smaller"></div>
    </div>
    <div id="sim-outline" style="display:none">
      <label>Simulation Outline
        <select name="simulation_outline_id">
          <option value=""></option>
          {% for o in simulation_outlines %}
            <option value="{{ o.id }}">{{ o.number }} — {{ o.skill }} — {{ o.descriptor }} ({{ o.level }})</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <div>
      <label>Material format
        <select name="materials_format" id="materials-format">
          <option value=""></option>
          {% for key,label in material_formats %}
            <option value="{{ key }}">{{ label }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <div id="material-sets"><label>Material Sets <input type="number" name="material_sets" min="0" value="0"></label></div>
    <div id="credits-field" style="display:none"><label># of credits (2 teams per credit) <input type="number" name="credits" min="0" value="2"></label></div>
    <fieldset class="components">
      <legend>Physical components</legend>
      {% for key,label in physical_components %}
        <label><input type="checkbox" name="components" value="{{ key }}"> {{ label }}</label><br>
      {% endfor %}
    </fieldset>
    <div>Order Date: <input type="date" name="order_date" value="{{ today }}"></div>
    <div>Latest arrival date: <input type="date" name="arrival_date"></div>
    <div>Ship date: <input type="date" name="ship_date"></div>
    <div>PO Number: <input type="text" name="materials_po_number"></div>

  </fieldset>
  <button type="submit">Save</button>
</form>
<dialog id="client-dialog">
  <form id="client-inline-form">
    <div><label>Name <input type="text" name="name" required></label></div>
    <div><label>SFC Link <input type="url" name="sfc_link"></label></div>
    <div><label>CRM
      <select name="crm_user_id">
        <option value=""></option>
        {% for u in users %}
        <option value="{{ u.id }}">{{ u.full_name or u.email }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Data Region
      <select name="data_region">
        <option value=""></option>
        {% for opt in ['NA','EU','SEA','Other'] %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div><label>Status
      <select name="status">
        {% for opt in ['active','inactive'] %}
          <option value="{{ opt }}" {% if opt=='active' %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
      </select>
    </label></div>
    <div style="margin-top:8px;">
      <button type="button" id="client-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<dialog id="shipping-dialog">
  <form id="shipping-inline-form">
    <div><label>Contact Name <input type="text" name="contact_name"></label></div>
    <div><label>Contact Phone <input type="text" name="contact_phone"></label></div>
    <div><label>Contact Email <input type="email" name="contact_email"></label></div>
    <div><label>Shipping Notes <input type="text" name="notes"></label></div>
    <div><label>Address line 1 <input type="text" name="address_line1" required></label></div>
    <div><label>Address line 2 <input type="text" name="address_line2"></label></div>
    <div><label>City <input type="text" name="city"></label></div>
    <div><label>State <input type="text" name="state"></label></div>
    <div><label>Postal Code <input type="text" name="postal_code"></label></div>
    <div><label>Country <input type="text" name="country"></label></div>
    <div><label>Active <input type="checkbox" name="is_active" value="1" checked></label></div>
    <div style="margin-top:8px;">
      <button type="button" id="shipping-cancel">Cancel</button>
      <button type="submit">Save</button>
    </div>
  </form>
</dialog>
<script>
  function clearErrors(form){
    form.querySelectorAll('.error').forEach(el=>el.remove());
  }
  function showErrors(form, errors){
    for(var k in errors){
      var field=form.querySelector('[name="'+k+'"]');
      if(field){
        var div=document.createElement('div');
        div.className='error';
        div.textContent=errors[k];
        field.insertAdjacentElement('afterend', div);
      }
    }
  }
  var langSelect = document.getElementById('lang-select');
  var typeSelect = document.getElementById('wt-select');
  function filterTypes(){
    if(!langSelect || !typeSelect) return;
    var lang = langSelect.value;
    Array.from(typeSelect.options).forEach(function(opt){
      if(!opt.value) return;
      var langs = (opt.dataset.langs || '').split(' ');
      var show = langs.indexOf(lang) !== -1;
      opt.hidden = !show;
      if(!show && opt.selected){ opt.selected = false; }
    });
    toggleExtras(orderType.value);
  }
  langSelect && langSelect.addEventListener('change', filterTypes);
  var clientSelect = document.getElementById('client-select');
  var shipSelect = document.getElementById('shipping-location-select');
  var addShip = document.getElementById('add-shipping-location');
  var editShip = document.getElementById('edit-shipping-locations');
  var nextUrl = "{{ url_for('materials_only.create') }}";
  function filterLocations(){
    if(!clientSelect || !shipSelect) return;
    var cid = clientSelect.value;
    Array.from(shipSelect.options).forEach(function(opt){
      if(!opt.value) return;
      var show = !cid || opt.dataset.client === cid;
      opt.hidden = !show;
      if(!show && opt.selected){ opt.selected = false; }
    });
    if(addShip && editShip){
      if(cid){
        addShip.style.display = 'inline';
        editShip.style.display = 'inline';
        editShip.href = '/clients/'+cid+'/edit?section=shipping&next=' + encodeURIComponent(nextUrl);
      }else{
        addShip.style.display = 'none';
        editShip.style.display = 'none';
      }
    }
  }
  clientSelect && clientSelect.addEventListener('change', filterLocations);
  var orderType = document.querySelector('select[name="order_type"]');
  var materialsDiv = document.getElementById('materials-type');
  var materialsSelect = document.getElementById('materials-option');
  var materialsInfo = document.getElementById('materials-option-info');
  var defaultMaterials = {};
  Array.from(typeSelect.options).forEach(function(opt){ defaultMaterials[opt.value] = opt.dataset.defaultMaterial || ''; });
  function updateMaterialsInfo(){
    if(!materialsSelect || !materialsInfo) return;
    var labels = Array.from(materialsSelect.selectedOptions).map(o=>o.textContent);
    materialsInfo.textContent = labels.join(', ');
  }
  function applyDefaultMaterial(){
    if(materialsSelect.dataset.touched) return;
    var wtId = typeSelect.value;
    var def = defaultMaterials[wtId];
    if(def){
      var opt = Array.from(materialsSelect.options).find(o => o.value == def);
      if(opt) opt.selected = true;
    }
    updateMaterialsInfo();
  }
  var materialSetsDiv = document.getElementById('material-sets');
  var creditsDiv = document.getElementById('credits-field');
  var simDiv = document.getElementById('sim-outline');
  function updateCreditsVisibility(ot){
    if(!creditsDiv) return;
    var opt = typeSelect.options[typeSelect.selectedIndex];
    var isSimType = opt && opt.dataset.sim === '1';
    var show = (ot === 'Simulation') || isSimType;
    creditsDiv.style.display = show ? 'block' : 'none';
  }
  function toggleExtras(ot){
    if(materialSetsDiv){ materialSetsDiv.style.display = (ot === 'Simulation') ? 'none' : 'block'; }
    updateCreditsVisibility(ot);
    if(simDiv){
      var opt = typeSelect.options[typeSelect.selectedIndex];
      var isSimType = opt && opt.dataset.sim === '1';
      var show = (ot === 'Simulation') || isSimType;
      simDiv.style.display = show ? 'block' : 'none';
    }
  }
  function loadOptions(ot){
    if(!materialsSelect) return;
    materialsSelect.innerHTML = '';
    materialsSelect.multiple = (ot === 'KT-Run Modular materials');
    if(ot !== 'KT-Run Modular materials'){
      var empty = document.createElement('option'); empty.value=''; materialsSelect.appendChild(empty);
    }
    materialsSelect.dataset.touched = '';
    fetch(orderType.dataset.optionsUrl + '?order_type=' + encodeURIComponent(ot))
      .then(r => r.json())
      .then(data => {
        data.options.forEach(function(opt){
          var o = document.createElement('option');
          o.value = opt.id; o.textContent = opt.title;
          materialsSelect.appendChild(o);
        });
        if(materialsDiv){ materialsDiv.style.display = ot ? 'block' : 'none'; }
        applyDefaultMaterial();
        updateMaterialsInfo();
      });
    toggleExtras(ot);
  }
  materialsSelect && materialsSelect.addEventListener('change', function(){ this.dataset.touched='1'; updateMaterialsInfo(); });
  typeSelect && typeSelect.addEventListener('change', function(){ applyDefaultMaterial(); toggleExtras(orderType.value); });
  orderType && orderType.addEventListener('change', function(){ loadOptions(this.value); });
  var fmtSel = document.getElementById('materials-format');
  var boxes = Array.from(document.querySelectorAll('input[name="components"]'));
  function applyComponentState(autoCheck=false){
    var fmt = fmtSel.value;
    var disable = (fmt === 'ALL_DIGITAL' || fmt === 'SIM_ONLY');
    boxes.forEach(b => { b.disabled = disable; if(disable){ b.checked = false; } });
    if(autoCheck && fmt === 'ALL_PHYSICAL') boxes.forEach(b => b.checked = true);
  }
  function applyAutoFormat(){
    if(orderType.value === 'Simulation' && !fmtSel.value){ fmtSel.value = 'SIM_ONLY'; }
    applyComponentState();
  }
  fmtSel && fmtSel.addEventListener('change', function(){ applyComponentState(true); });
  orderType && orderType.addEventListener('change', applyAutoFormat);
  var clientDialog = document.getElementById('client-dialog');
  var clientForm = document.getElementById('client-inline-form');
  document.getElementById('add-client').addEventListener('click', function(e){
    e.preventDefault();
    clientForm.reset();
    clearErrors(clientForm);
    clientDialog.showModal();
  });
  document.getElementById('client-cancel').addEventListener('click', function(){ clientDialog.close(); });
  clientForm.addEventListener('submit', function(e){
    e.preventDefault();
    clearErrors(clientForm);
    var fd=new FormData(clientForm);
    fetch('/clients/inline-new', {method:'POST', body:fd})
      .then(r=>r.json().then(data=>[r.status,data]))
      .then(([status,data])=>{
        if(status==200 && data.id){
          var o=document.createElement('option');
          o.value=data.id; o.textContent=data.name; if(data.crm){ o.dataset.crm=data.crm; }
          clientSelect.appendChild(o);
          clientSelect.value=data.id;
          clientDialog.close();
          clientSelect.dispatchEvent(new Event('change'));
        }else if(data.errors){
          showErrors(clientForm, data.errors);
        }
      });
  });
  if(addShip){
    var shipDialog = document.getElementById('shipping-dialog');
    var shipForm = document.getElementById('shipping-inline-form');
    addShip.addEventListener('click', function(e){
      e.preventDefault();
      shipForm.reset();
      clearErrors(shipForm);
      shipDialog.showModal();
    });
    document.getElementById('shipping-cancel').addEventListener('click', function(){ shipDialog.close(); });
    shipForm.addEventListener('submit', function(e){
      e.preventDefault();
      clearErrors(shipForm);
      var cid = clientSelect.value;
      if(!cid) return;
      var fd=new FormData(shipForm);
      fetch('/clients/'+cid+'/inline-shipping-location', {method:'POST', body:fd})
        .then(r=>r.json().then(data=>[r.status,data]))
        .then(([status,data])=>{
          if(status==200 && data.id){
            var o=document.createElement('option');
            o.value=data.id; o.textContent=data.display;
            shipSelect.appendChild(o); shipSelect.value=data.id;
            shipDialog.close();
          }else if(data.errors){
            showErrors(shipForm, data.errors);
          }
        });
    });
  }
  filterTypes();
  filterLocations();
  loadOptions(orderType.value);
  applyAutoFormat();
  toggleExtras(orderType.value);
</script>
{% endblock %}
